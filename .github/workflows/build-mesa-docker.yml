# build-mesa-docker.yml
name: Build Mesa for Linbox (aarch64) with Docker

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa åˆ†æ”¯ (å¯é€‰ï¼Œé»˜è®¤ä¸º adreno-main)'
        required: false
        default: 'adreno-main'
        type: string
      use_upstream:
        description: 'æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa (è€Œä¸æ˜¯ lfdevs çš„åˆ†æ”¯)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æ ‡å‡† x86_64 runner
    
    steps:
    - name: è®¾ç½®æ„å»ºå‚æ•°
      id: setup
      run: |
        # è®¾ç½®é»˜è®¤å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "MESA_BRANCH=${{ github.event.inputs.mesa_branch }}" >> $GITHUB_ENV
          echo "USE_UPSTREAM=${{ github.event.inputs.use_upstream }}" >> $GITHUB_ENV
        else
          echo "MESA_BRANCH=adreno-main" >> $GITHUB_ENV
          echo "USE_UPSTREAM=false" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        # è®¾ç½®ç›®æ ‡æ¶æ„
        echo "TARGET_ARCH=aarch64-linux-gnu" >> $GITHUB_ENV
        echo "HOST_ARCH=$(uname -m)" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨çš„ Mesa åˆ†æ”¯: $MESA_BRANCH"
        echo "æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸: $USE_UPSTREAM"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"
        echo "ä¸»æœºæ¶æ„: $HOST_ARCH"

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½® QEMU ç”¨äºè·¨æ¶æ„ç¼–è¯‘
      uses: docker/setup-qemu-action@v3

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: åˆ›å»º Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        # ä½¿ç”¨ Ubuntu ä½œä¸ºåŸºç¡€é•œåƒä»¥è·å¾—æ›´å¥½çš„å…¼å®¹æ€§
        FROM ubuntu:22.04 AS builder
        
        # è®¾ç½®éäº¤äº’å¼ç¯å¢ƒ
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=UTC
        
        # è®¾ç½®æ„å»ºå‚æ•°
        ARG MESA_BRANCH=adreno-main
        ARG USE_UPSTREAM=false
        
        WORKDIR /build
        
        # å®‰è£…å¿…è¦çš„ä¾èµ–
        RUN apt-get update && apt-get install -y --no-install-recommends \
            ca-certificates \
            gnupg \
            wget \
            curl \
            git \
            build-essential \
            python3 \
            python3-pip \
            python3-setuptools \
            meson \
            ninja-build \
            pkg-config \
            bison \
            flex \
            libwayland-dev \
            wayland-protocols \
            libwayland-egl-backend-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxcb-glx0-dev \
            libxcb-dri2-0-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-shm0-dev \
            libxcb-sync-dev \
            libxrandr-dev \
            libxxf86vm-dev \
            libdrm-dev \
            x11proto-dev \
            libxshmfence-dev \
            libvulkan-dev \
            libelf-dev \
            libexpat1-dev \
            libxml2-dev \
            libz-dev \
            libunwind-dev \
            libgles2-mesa-dev \
            libegl1-mesa-dev \
            libgbm-dev \
            llvm-19 \
            llvm-19-dev \
            clang-19 \
            libclang-19-dev \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            libc6-dev-arm64-cross \
            crossbuild-essential-arm64 \
            && rm -rf /var/lib/apt/lists/*
        
        # å®‰è£… Python æ„å»ºå·¥å…·
        RUN pip3 install meson mako
        
        # å…‹éš† Mesa æºç 
        RUN if [ "$USE_UPSTREAM" = "true" ]; then \
            echo "ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa ä»“åº“" && \
            git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa-src; \
        else \
            echo "ä½¿ç”¨ lfdevs çš„ Mesa for Android Container ä»“åº“" && \
            git clone https://github.com/lfdevs/mesa-for-android-container.git mesa-src && \
            cd mesa-src && \
            if [ "$MESA_BRANCH" != "main" ]; then \
                git checkout $MESA_BRANCH || echo "åˆ†æ”¯ä¸å­˜åœ¨ï¼Œä½¿ç”¨ main"; \
            fi && \
            cd ..; \
        fi
        
        WORKDIR /build/mesa-src
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        RUN git rev-parse --short HEAD > /tmp/git_hash.txt && \
            if [ -f "VERSION" ]; then \
                cat VERSION > /tmp/version.txt; \
            else \
                echo "git-$(cat /tmp/git_hash.txt)" > /tmp/version.txt; \
            fi
        
        # é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ
        ENV CC="aarch64-linux-gnu-gcc"
        ENV CXX="aarch64-linux-gnu-g++"
        ENV AR="aarch64-linux-gnu-ar"
        ENV LD="aarch64-linux-gnu-ld"
        ENV STRIP="aarch64-linux-gnu-strip"
        ENV PKG_CONFIG="aarch64-linux-gnu-pkg-config"
        ENV PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
        ENV CFLAGS="-O3 -march=armv8-a -mtune=cortex-a76 -fPIC"
        ENV CXXFLAGS="-O3 -march=armv8-a -mtune=cortex-a76 -fPIC"
        ENV LDFLAGS="-Wl,--hash-style=both"
        
        # åˆ›å»ºæ„å»ºç›®å½•å¹¶é…ç½®
        RUN mkdir -p build && \
            meson setup build \
              --prefix=/opt/mesa \
              --cross-file=/usr/share/meson/cross/aarch64-linux-gnu.txt \
              -Dbuildtype=release \
              -Doptimization=3 \
              -Db_lto=true \
              -Dplatforms=x11 \
              -Ddri-drivers= \
              -Dgallium-drivers=zink,freedreno \
              -Dvulkan-drivers=freedreno \
              -Dllvm=enabled \
              -Dshared-llvm=disabled \
              -Dglvnd=false \
              -Degl=enabled \
              -Dgbm=enabled \
              -Dglx=disabled \
              -Degl-native-platform=x11 \
              -Dgles1=enabled \
              -Dgles2=enabled \
              -Dopengl=true \
              -Dshared-glapi=enabled \
              -Dlibunwind=disabled \
              -Dvalgrind=disabled
        
        # æ„å»º Mesa
        RUN ninja -C build -j$(nproc) 2>&1 | tee /tmp/build.log
        
        # å®‰è£…åˆ°ä¸´æ—¶ç›®å½•
        RUN DESTDIR=/tmp/mesa-install ninja -C build install
        
        # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
        RUN mkdir -p /output/opt/mesa && \
            cp -r /tmp/mesa-install/opt/mesa/* /output/opt/mesa/ && \
            cp /tmp/git_hash.txt /tmp/version.txt /tmp/build.log /output/
        
        # åˆ›å»ºç¯å¢ƒè®¾ç½®è„šæœ¬
        RUN cat > /output/env.sh << 'ENVEOF'
        #!/bin/bash
        export MESA_PATH=/opt/mesa
        export LD_LIBRARY_PATH=\$MESA_PATH/lib/aarch64-linux-gnu:\$MESA_PATH/lib:\$LD_LIBRARY_PATH
        export LIBGL_DRIVERS_PATH=\$MESA_PATH/lib/aarch64-linux-gnu/dri
        export VK_ICD_FILENAMES=\$MESA_PATH/share/vulkan/icd.d/freedreno_icd.aarch64.json
        export EGL_PLATFORM=x11
        export GALLIUM_DRIVER=zink
        ENVEOF
        
        RUN chmod +x /output/env.sh
        
        # æœ€ç»ˆé˜¶æ®µ - åˆ›å»ºæœ€å°é•œåƒ
        FROM scratch AS artifact
        COPY --from=builder /output/ /mesa-build/
        
        EOF

    - name: æ„å»º Docker é•œåƒå¹¶ç¼–è¯‘ Mesa
      run: |
        echo "ğŸ³ æ„å»º Docker é•œåƒå¹¶ç¼–è¯‘ Mesa..."
        
        # æ„å»º Docker é•œåƒ
        docker buildx build \
          --platform linux/arm64 \
          --output type=local,dest=./mesa-output \
          --build-arg MESA_BRANCH="${{ env.MESA_BRANCH }}" \
          --build-arg USE_UPSTREAM="${{ env.USE_UPSTREAM }}" \
          -t mesa-builder:latest \
          .
        
        # æ£€æŸ¥è¾“å‡ºç›®å½•
        if [ -d "mesa-output" ]; then
          echo "âœ… Docker æ„å»ºå®Œæˆ"
          ls -la mesa-output/
        else
          echo "âŒ Docker æ„å»ºå¤±è´¥"
          exit 1
        fi

    - name: æå–æ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ“‹ æå–æ„å»ºä¿¡æ¯..."
        
        if [ -f "mesa-output/version.txt" ]; then
          MESA_VERSION=$(cat mesa-output/version.txt)
          echo "MESA_VERSION=$MESA_VERSION" >> $GITHUB_ENV
        fi
        
        if [ -f "mesa-output/git_hash.txt" ]; then
          MESA_GIT_HASH=$(cat mesa-output/git_hash.txt)
          echo "MESA_GIT_HASH=$MESA_GIT_HASH" >> $GITHUB_ENV
        fi
        
        if [ -z "$MESA_VERSION" ]; then
          echo "MESA_VERSION=custom-${{ env.BUILD_DATE }}" >> $GITHUB_ENV
        fi
        
        echo "Mesa ç‰ˆæœ¬: ${MESA_VERSION:-æœªçŸ¥}"
        echo "Git å“ˆå¸Œ: ${MESA_GIT_HASH:-æœªçŸ¥}"

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
        
        cd mesa-output
        
        if [ ! -d "opt/mesa" ]; then
          echo "âŒ æ„å»ºå¤±è´¥: opt/mesa ç›®å½•ä¸å­˜åœ¨"
          ls -la
          exit 1
        fi
        
        echo "âœ… æ„å»ºç›®å½•ç»“æ„:"
        find opt/mesa -type f -name "*.so" | head -10 || true
        find opt/mesa -type f -name "*.so.*" | head -10 || true
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        echo "æ£€æŸ¥å…³é”®æ–‡ä»¶:"
        if [ -f "opt/mesa/lib/aarch64-linux-gnu/libGL.so" ] || \
           [ -f "opt/mesa/lib/aarch64-linux-gnu/libGL.so.1" ]; then
          echo "âœ… æ‰¾åˆ° libGL"
        else
          echo "âš ï¸  ç¼ºå°‘ libGL"
          # åˆ—å‡º lib ç›®å½•å†…å®¹
          ls -la opt/mesa/lib/ 2>/dev/null || true
          ls -la opt/mesa/lib/aarch64-linux-gnu/ 2>/dev/null || true
        fi

    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©..."
        
        cd mesa-output
        
        # ä½¿ç”¨æå–çš„ç‰ˆæœ¬æˆ–é»˜è®¤å€¼
        MESA_VERSION="${MESA_VERSION:-custom-${{ env.BUILD_DATE }}}"
        PACKAGE_NAME="glibcmesa-${MESA_VERSION// /-}-aarch64"
        
        # æ‰“åŒ…æ•´ä¸ªç›®å½•
        tar -czvf "../${PACKAGE_NAME}-full.tar.gz" .
        
        cd ..
        
        # åˆ›å»ºæ ¡éªŒå’Œ
        sha256sum ${PACKAGE_NAME}-full.tar.gz > checksums.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: glibcmesa-${{ env.MESA_VERSION }}-aarch64
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: åˆ›å»ºè½»é‡çº§å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: glibcmesa-${{ env.MESA_VERSION }}-${{ env.BUILD_DATE }}
        name: Mesa Proot ${{ env.MESA_VERSION }} (aarch64)
        body: |
          Mesa 3D Graphics Library for Termux Proot (glibc) on aarch64
          
          **ä½¿ç”¨ Docker äº¤å‰ç¼–è¯‘ï¼Œé¿å…ç¯å¢ƒä¾èµ–é—®é¢˜**
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.MESA_VERSION }}
          - **Git å“ˆå¸Œ**: ${{ env.MESA_GIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **åˆ†æ”¯**: ${{ env.MESA_BRANCH }}
          - **ä»“åº“**: $(if [ "${{ env.USE_UPSTREAM }}" = "true" ]; then echo "ä¸Šæ¸¸å®˜æ–¹"; else echo "lfdevs/android-container"; fi)
          - **ç¼–è¯‘æ–¹å¼**: Docker äº¤å‰ç¼–è¯‘ (x86_64 â†’ aarch64)
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.FULL_PACKAGE }}` - å®Œæ•´ Mesa å®‰è£…åŒ…
          - `checksums.txt` - æ ¡éªŒå’Œæ–‡ä»¶
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´çš„ tar.gz åŒ…
          2. è§£å‹åˆ° Proot ç¯å¢ƒçš„æ ¹ç›®å½•: `tar -xzf package.tar.gz -C /`
          3. è®¾ç½®ç¯å¢ƒå˜é‡ (å·²åŒ…å« env.sh è„šæœ¬):
             ```bash
             source /opt/mesa/env.sh
             ```
          
          æˆ–æ‰‹åŠ¨è®¾ç½®:
          ```bash
          export LD_LIBRARY_PATH=/opt/mesa/lib/aarch64-linux-gnu:$LD_LIBRARY_PATH
          export LIBGL_DRIVERS_PATH=/opt/mesa/lib/aarch64-linux-gnu/dri
          export VK_ICD_FILENAMES=/opt/mesa/share/vulkan/icd.d/freedreno_icd.aarch64.json
          ```
          
          åŒ…å«çš„é©±åŠ¨:
          - **Gallium**: zink, freedreno
          - **Vulkan**: freedreno
          - **OpenGL**: é€šè¿‡ zink è½¬æ¢å±‚
          - **OpenGL ES**: 1.x, 2.x
          - **EGL**: æ”¯æŒ
          - **GBM**: æ”¯æŒ
          
          æ³¨æ„:
          - éœ€è¦ Termux çš„ glibc ç¯å¢ƒ
          - æ¨èåœ¨ Proot å®¹å™¨ä¸­ä½¿ç”¨
          - ä½¿ç”¨ zink ä½œä¸ºä¸»è¦çš„ OpenGL å®ç°
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“
      run: |
        echo "âœ… Mesa Proot äº¤å‰ç¼–è¯‘å®Œæˆ!"
        echo "================================"
        echo "ç‰ˆæœ¬: ${MESA_VERSION:-custom-${{ env.BUILD_DATE }}}"
        echo "æäº¤: ${MESA_GIT_HASH:-æœªçŸ¥}"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "åˆ†æ”¯: $MESA_BRANCH"
        echo "ç›®æ ‡æ¶æ„: aarch64"
        echo "ç¼–è¯‘æ¶æ„: x86_64 (äº¤å‰ç¼–è¯‘)"
        echo "ç¼–è¯‘æ–¹å¼: Docker å®¹å™¨"
        echo "ç¯å¢ƒ: Termux Proot (glibc)"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        echo "é©±åŠ¨æ”¯æŒ:"
        echo "  âœ“ Gallium: zink, freedreno"
        echo "  âœ“ Vulkan: freedreno"
        echo "  âœ“ OpenGL (é€šè¿‡ zink), OpenGL ES 1.x/2.x"
        echo "  âœ“ EGL, GBM"          # æ£€å‡ºæŒ‡å®šåˆ†æ”¯
          if [ -n "$MESA_BRANCH" ] && [ "$MESA_BRANCH" != "main" ]; then
            echo "æ£€å‡ºåˆ†æ”¯: $MESA_BRANCH"
            git checkout $MESA_BRANCH
          fi
        fi
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        GIT_HASH=$(git rev-parse --short HEAD)
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION="git-$GIT_HASH"
        fi
        
        echo "MESA_VERSION=$OFFICIAL_VERSION" >> /tmp/build_env.txt
        echo "MESA_GIT_HASH=$GIT_HASH" >> /tmp/build_env.txt
        
        echo "ğŸ”¨ é…ç½®äº¤å‰ç¼–è¯‘..."
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
        export CC="aarch64-linux-gnu-gcc"
        export CXX="aarch64-linux-gnu-g++"
        export AR="aarch64-linux-gnu-ar"
        export LD="aarch64-linux-gnu-ld"
        export STRIP="aarch64-linux-gnu-strip"
        export PKG_CONFIG="aarch64-linux-gnu-pkg-config"
        export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
        export CFLAGS="-O3 -march=armv8-a -mtune=cortex-a76 -fPIC"
        export CXXFLAGS="-O3 -march=armv8-a -mtune=cortex-a76 -fPIC"
        
        # é…ç½® Mesa
        meson setup build \
          --prefix=/opt/mesa \
          --cross-file=/usr/share/meson/cross/aarch64-linux-gnu.txt \
          -Dbuildtype=release \
          -Doptimization=3 \
          -Db_lto=true \
          -Dplatforms=x11,wayland \
          -Ddri-drivers= \
          -Dgallium-drivers=zink,freedreno,llvmpipe,softpipe \
          -Dvulkan-drivers=freedreno,swrast \
          -Dgallium-opencl=disabled \
          -Dopencl-spirv=false \
          -Dllvm=enabled \
          -Dshared-llvm=enabled \
          -Dglvnd=false \
          -Degl=enabled \
          -Dgbm=enabled \
          -Dglx=disabled \
          -Degl-native-platform=x11 \
          -Dgles1=enabled \
          -Dgles2=enabled \
          -Dopengl=true \
          -Dshared-glapi=enabled \
          -Dlibunwind=disabled \
          -Dvalgrind=disabled \
          -Dtools=freedreno
        
        echo "ğŸ—ï¸  å¼€å§‹æ„å»º Mesa..."
        
        # æ„å»º
        ninja -C build -j$(nproc)
        
        echo "ğŸ“¦ å®‰è£…åˆ°ä¸´æ—¶ç›®å½•..."
        
        # å®‰è£…åˆ°ä¸´æ—¶ç›®å½•
        DESTDIR=/tmp/mesa-install ninja -C build install
        
        echo "âœ… æ„å»ºå®Œæˆ!"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        mkdir -p /tmp/mesa-package/opt/mesa
        cp -r /tmp/mesa-install/opt/mesa/* /tmp/mesa-package/opt/mesa/
        
        # åˆ›å»ºç¯å¢ƒè®¾ç½®è„šæœ¬
        cat > /tmp/mesa-package/env.sh << 'ENVEOF'
        #!/bin/bash
        export MESA_PATH=/opt/mesa
        export LD_LIBRARY_PATH=\$MESA_PATH/lib/aarch64-linux-gnu:\$MESA_PATH/lib:\$LD_LIBRARY_PATH
        export LIBGL_DRIVERS_PATH=\$MESA_PATH/lib/aarch64-linux-gnu/dri
        export VK_ICD_FILENAMES=\$MESA_PATH/share/vulkan/icd.d/freedreno_icd.aarch64.json
        export EGL_PLATFORM=x11
        export GALLIUM_DRIVER=zink
        export MESA_LOADER_DRIVER_OVERRIDE=zink
        ENVEOF
        
        chmod +x /tmp/mesa-package/env.sh
        EOF
        
        chmod +x build-mesa-docker.sh

    - name: åœ¨ Docker å®¹å™¨ä¸­æ„å»º Mesa
      run: |
        echo "ğŸ³ å¯åŠ¨ Docker å®¹å™¨è¿›è¡Œäº¤å‰ç¼–è¯‘..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p mesa-output
        
        # è¿è¡Œ Docker å®¹å™¨è¿›è¡Œæ„å»º
        docker run --rm \
          --platform linux/arm64 \
          -v $(pwd)/build-mesa-docker.sh:/build.sh:ro \
          -v $(pwd)/mesa-output:/output \
          -e MESA_BRANCH="${{ env.MESA_BRANCH }}" \
          -e USE_UPSTREAM="${{ env.USE_UPSTREAM }}" \
          debian:bookworm-slim \
          /bin/bash -c "
            apt-get update && apt-get install -y wget
            chmod +x /build.sh
            /build.sh
            cp -r /tmp/mesa-package/* /output/
            cp /tmp/build_env.txt /output/build_env.txt 2>/dev/null || true
          "
        
        # è¯»å–æ„å»ºç¯å¢ƒä¿¡æ¯
        if [ -f "mesa-output/build_env.txt" ]; then
          source mesa-output/build_env.txt
          echo "MESA_VERSION=${MESA_VERSION}" >> $GITHUB_ENV
          echo "MESA_GIT_HASH=${MESA_GIT_HASH}" >> $GITHUB_ENV
        fi

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
        
        cd mesa-output
        
        if [ ! -d "opt/mesa" ]; then
          echo "âŒ æ„å»ºå¤±è´¥: opt/mesa ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ„å»ºç›®å½•ç»“æ„:"
        find opt/mesa -type f -name "*.so" | head -20
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        REQUIRED_FILES=(
          "opt/mesa/lib/aarch64-linux-gnu/libGL.so"
          "opt/mesa/lib/aarch64-linux-gnu/libEGL.so"
          "opt/mesa/lib/aarch64-linux-gnu/libglapi.so"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… æ‰¾åˆ°: $file"
          else
            echo "âš ï¸  ç¼ºå°‘: $file"
          fi
        done

    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©..."
        
        cd mesa-output
        
        # åˆ›å»ºç‰ˆæœ¬åŒ–çš„åŒ…å
        PACKAGE_NAME="glibcmesa-${MESA_VERSION:-custom}-aarch64"
        
        # æ‰“åŒ…æ•´ä¸ªç›®å½•
        tar -czvf "../${PACKAGE_NAME}-full.tar.gz" .
        
        cd ..
        
        # åˆ›å»ºæ ¡éªŒå’Œ
        sha256sum ${PACKAGE_NAME}-full.tar.gz > checksums.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: glibcmesa-${{ env.MESA_VERSION }}-aarch64
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: åˆ›å»ºè½»é‡çº§å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: glibcmesa-${{ env.MESA_VERSION }}-${{ env.BUILD_DATE }}
        name: Mesa Proot ${{ env.MESA_VERSION }} (aarch64)
        body: |
          Mesa 3D Graphics Library for Termux Proot (glibc) on aarch64
          
          **ä½¿ç”¨ Docker äº¤å‰ç¼–è¯‘ï¼Œé¿å…ç¯å¢ƒä¾èµ–é—®é¢˜**
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.MESA_VERSION }}
          - **Git å“ˆå¸Œ**: ${{ env.MESA_GIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **åˆ†æ”¯**: ${{ env.MESA_BRANCH }}
          - **ä»“åº“**: $(if [ "${{ env.USE_UPSTREAM }}" = "true" ]; then echo "ä¸Šæ¸¸å®˜æ–¹"; else echo "lfdevs/android-container"; fi)
          - **ç¼–è¯‘æ–¹å¼**: Docker äº¤å‰ç¼–è¯‘ (x86_64 â†’ aarch64)
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.FULL_PACKAGE }}` - å®Œæ•´ Mesa å®‰è£…åŒ…
          - `checksums.txt` - æ ¡éªŒå’Œæ–‡ä»¶
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´çš„ tar.gz åŒ…
          2. è§£å‹åˆ° Proot ç¯å¢ƒçš„æ ¹ç›®å½•: `tar -xzf package.tar.gz -C /`
          3. è®¾ç½®ç¯å¢ƒå˜é‡ (å·²åŒ…å« env.sh è„šæœ¬):
             ```bash
             source /opt/mesa/env.sh
             ```
          
          æˆ–æ‰‹åŠ¨è®¾ç½®:
          ```bash
          export LD_LIBRARY_PATH=/opt/mesa/lib/aarch64-linux-gnu:$LD_LIBRARY_PATH
          export LIBGL_DRIVERS_PATH=/opt/mesa/lib/aarch64-linux-gnu/dri
          export VK_ICD_FILENAMES=/opt/mesa/share/vulkan/icd.d/freedreno_icd.aarch64.json
          ```
          
          åŒ…å«çš„é©±åŠ¨:
          - **Gallium**: zink, freedreno, llvmpipe, softpipe
          - **Vulkan**: freedreno, swrast
          - **OpenGL**: 3.0+ (é€šè¿‡ zink)
          - **OpenGL ES**: 1.x, 2.x
          - **EGL**: æ”¯æŒ
          - **GBM**: æ”¯æŒ
          
          æ³¨æ„:
          - éœ€è¦ Termux çš„ glibc ç¯å¢ƒ (å¦‚ glibcdistro çš„ Ubuntu/Debian)
          - æ¨èåœ¨ Proot å®¹å™¨ä¸­ä½¿ç”¨
          - ä½¿ç”¨ zink ä½œä¸ºä¸»è¦çš„ OpenGL å®ç°
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“
      run: |
        echo "âœ… Mesa Proot äº¤å‰ç¼–è¯‘å®Œæˆ!"
        echo "================================"
        echo "ç‰ˆæœ¬: ${MESA_VERSION:-æœªçŸ¥}"
        echo "æäº¤: ${MESA_GIT_HASH:-æœªçŸ¥}"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "åˆ†æ”¯: $MESA_BRANCH"
        echo "ç›®æ ‡æ¶æ„: aarch64"
        echo "ç¼–è¯‘æ¶æ„: x86_64 (äº¤å‰ç¼–è¯‘)"
        echo "ç¼–è¯‘æ–¹å¼: Docker å®¹å™¨"
        echo "ç¯å¢ƒ: Termux Proot (glibc)"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        echo "é©±åŠ¨æ”¯æŒ:"
        echo "  âœ“ Gallium: zink, freedreno, llvmpipe, softpipe"
        echo "  âœ“ Vulkan: freedreno, swrast"
        echo "  âœ“ OpenGL (é€šè¿‡ zink), OpenGL ES 1.x/2.x"
        echo "  âœ“ EGL, GBM"

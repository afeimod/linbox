# build-wine-test.yml
name: Build TestWine WOW64 for Termux

on:
  workflow_dispatch:  # 只保留手动触发

permissions:
  contents: write  # 允许 GITHUB_TOKEN 创建 Release

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用更稳定的 Ubuntu 22.04

    steps:
    - name: 安装构建依赖
      run: |
        sudo apt update
        sudo apt --fix-broken install -y
        
        # 添加 32 位架构支持
        sudo dpkg --add-architecture i386
        sudo apt update
        
        # 先安装基础构建工具和缺失的依赖
        sudo apt install -y \
          git wget xz-utils autoconf flex bison \
          gcc-multilib g++-multilib \
          build-essential pkg-config \
          mingw-w64 gettext libgettextpo-dev \
          locales language-pack-zh-hans ccache \
          libunwind-dev libunwind-dev:i386  # 添加缺失的依赖

        # 安装完整的 64 位开发库
        sudo apt install -y \
          libx11-dev libxext-dev libxi-dev libxrandr-dev \
          libxcursor-dev libxcomposite-dev libxdamage-dev \
          libxfixes-dev libxxf86vm-dev libxrender-dev \
          libxinerama-dev libgl-dev libglu-dev \
          libosmesa6-dev libfreetype6-dev libfontconfig1-dev \
          libpcap-dev libdbus-1-dev libssl-dev \
          libasound2-dev libpulse-dev libudev-dev \
          libcups2-dev libjpeg-dev libpng-dev libtiff-dev \
          libxml2-dev libvulkan-dev vulkan-tools \
          libvulkan1 mesa-vulkan-drivers \
          libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
          libmpg123-dev libopenal-dev

        # 安装完整的 32 位开发库
        sudo apt install -y \
          libc6-dev-i386 \
          libx11-dev:i386 libxext-dev:i386 libxi-dev:i386 \
          libxrandr-dev:i386 libxcursor-dev:i386 \
          libxcomposite-dev:i386 libxdamage-dev:i386 \
          libxfixes-dev:i386 libxxf86vm-dev:i386 \
          libxrender-dev:i386 libxinerama-dev:i386 \
          libgl-dev:i386 libglu-dev:i386 \
          libfreetype6-dev:i386 libfontconfig1-dev:i386 \
          libpcap-dev:i386 libdbus-1-dev:i386 \
          libasound2-dev:i386 libpulse-dev:i386 \
          libcups2-dev:i386 libjpeg-dev:i386 \
          libpng-dev:i386 libtiff-dev:i386 \
          libxml2-dev:i386 libvulkan-dev:i386 \
          libgstreamer1.0-dev:i386 libgstreamer-plugins-base1.0-dev:i386 \
          libmpg123-dev:i386 libopenal-dev:i386

        # 修复任何可能的依赖问题
        sudo apt --fix-broken install -y || true

    - name: 设置中文语言环境
      run: |
        sudo locale-gen zh_CN.UTF-8
        sudo update-locale LANG=zh_CN.UTF-8
        export LANG=zh_CN.UTF-8
        export LC_ALL=zh_CN.UTF-8

    - name: 克隆 Wine 源码
      run: |
        git clone https://gitlab.winehq.org/wine/wine.git
        cd wine
        # 使用稳定版本
        git checkout wine-9.0  # 使用已知稳定的版本

    - name: 应用关键补丁
      run: |
        cd wine
        
        # 只应用 DXGI 管理器补丁，移除有问题的字节流处理程序修改
        cat > wine_dxgi_only.patch << 'EOF'
        --- a/dlls/mfplat/main.c
        +++ b/dlls/mfplat/main.c
        @@ -9222,6 +9222,13 @@
         HRESULT WINAPI MFCreateDXGIDeviceManager(UINT *token, IMFDXGIDeviceManager **manager)
         {
             struct dxgi_device_manager *object;
        +    const char *do_not_create = getenv("WINE_DO_NOT_CREATE_DXGI_DEVICE_MANAGER");
         
             TRACE("%p, %p.\n", token, manager);
         
        +    if (do_not_create && do_not_create[0] != '\0')
        +    {
        +        FIXME("stubbing out\n");
        +        return E_NOTIMPL;
        +    }
        +
             if (!token || !manager)
                 return E_POINTER;
        EOF
        
        if patch -p1 -N < wine_dxgi_only.patch; then
            echo "✅ DXGI-only 补丁应用成功"
        else
            echo "⚠️ DXGI-only 补丁应用失败，继续构建"
        fi

        # 应用 esync 补丁
        wget -O esync.patch https://github.com/afeimod/linbox/raw/main/path/esync.patch
        if patch -p1 -N < esync.patch; then
            echo "✅ esync 补丁应用成功"
        else
            echo "⚠️ esync 补丁应用失败，继续构建"
        fi

        # 应用 Termux 路径修复补丁 - 修正 tmp 路径
        cat > termux-paths.patch << 'EOF'
        diff --git a/dlls/ntdll/unix/server.c b/dlls/ntdll/unix/server.c
        index 1234567..890abcd 100644
        --- a/dlls/ntdll/unix/server.c
        +++ b/dlls/ntdll/unix/server.c
        @@ -500,7 +500,7 @@ static void setup_server_dir( void )
             struct stat st;
             const char *tmpdir;
         
        -    tmpdir = getenv( "TMPDIR" );
        +    tmpdir = "@TERMUX_PREFIX@/tmp";
             if (!tmpdir || stat( tmpdir, &st ) == -1) tmpdir = "/tmp";
             if (stat( tmpdir, &st ) == -1)
             {
        EOF
        
        # 使用 sed 替换占位符为实际的 Termux 路径
        sed -i 's|@TERMUX_PREFIX@|/data/data/com.termux/files/usr|g' termux-paths.patch
        
        if patch -p1 -N < termux-paths.patch; then
            echo "✅ Termux 路径补丁应用成功"
        else
            echo "⚠️ Termux 路径补丁应用失败，继续构建"
        fi

    - name: 准备构建环境
      run: |
        cd wine
        # 生成必要的文件
        if [ -f "dlls/winevulkan/make_vulkan" ]; then
            dlls/winevulkan/make_vulkan
        fi
        if [ -f "tools/make_requests" ]; then
            tools/make_requests
        fi
        if [ -f "tools/make_specfiles" ]; then
            tools/make_specfiles
        fi
        
        # 运行 autoconf 生成 configure 脚本
        if [ -f "autogen.sh" ]; then
            ./autogen.sh
        else
            autoreconf -f
        fi

    - name: 构建真正的 WOW64 Wine（正确的方法）
      run: |
        cd wine
        mkdir -p /tmp/wine-install
        sudo chmod 777 -R /tmp/wine-install

        # 方法1：使用 --enable-win64 构建真正的 WOW64
        echo "构建真正的 WOW64 Wine..."
        mkdir -p build-wow64
        cd build-wow64
        
        # 配置真正的 WOW64 Wine
        ../configure \
          --enable-win64 \
          --prefix=/tmp/wine-install \
          --with-x \
          --with-vulkan \
          --with-gstreamer \
          --with-alsa \
          --with-pulse \
          --with-dbus \
          --with-cups \
          --with-freetype \
          --with-fontconfig \
          --without-ldap --without-oss \
          --disable-winemenubuilder --disable-win16 --disable-tests
        
        # 构建并安装
        make -j$(nproc) install

    - name: 验证 WOW64 构建
      run: |
        cd /tmp/wine-install
        echo "检查 WOW64 构建结果:"
        find . -name "*wine*" -type f | head -20
        echo "检查 bin 目录:"
        ls -la bin/ || echo "bin 目录不存在"
        echo "检查 lib 目录:"
        ls -la lib/ || echo "lib 目录不存在"
        echo "检查 lib64 目录:"
        ls -la lib64/ || echo "lib64 目录不存在"

    - name: 构建 32 位支持（如果需要）
      run: |
        cd wine
        
        # 如果需要完整的 32 位支持，构建 32 位版本
        echo "构建 32 位 Wine 支持..."
        mkdir -p build32
        cd build32
        
        # 配置 32 位 Wine
        PKG_CONFIG_LIBDIR=/usr/lib/i386-linux-gnu/pkgconfig \
        ../configure \
          --prefix=/tmp/wine32 \
          --with-x \
          --with-alsa \
          --with-pulse \
          --with-dbus \
          --with-cups \
          --with-freetype \
          --with-fontconfig \
          --without-ldap --without-oss \
          --disable-winemenubuilder --disable-win16 --disable-tests
        
        # 构建 32 位版本
        make -j$(nproc)
        
        # 复制 32 位文件到 WOW64 安装目录
        mkdir -p /tmp/wine-install/lib32/wine
        mkdir -p /tmp/wine-install/bin32
        cp -r /tmp/wine32/lib/wine/* /tmp/wine-install/lib32/wine/ 2>/dev/null || true
        cp /tmp/wine32/bin/wine /tmp/wine-install/bin32/ 2>/dev/null || true
        cp /tmp/wine32/bin/wine-preloader /tmp/wine-install/bin32/ 2>/dev/null || true

    - name: 准备 Termux 包
      run: |
        mkdir -p wine-package/opt/wine
        mkdir -p wine-package/bin
        mkdir -p wine-package/share/fonts
        
        # 复制 Wine 安装文件
        cp -r /tmp/wine-install/* wine-package/opt/wine/
        
        # 下载中文字体
        cd wine-package/share/fonts
        wget -q https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SourceHanSansSC-Regular.otf || true
        wget -q https://github.com/adobe-fonts/source-han-serif/raw/release/OTF/SourceHanSerifSC-Regular.otf || true
        cd ../../..

    - name: 创建真正的 WOW64 包装脚本
      run: |
        # 创建真正的 WOW64 wine 包装脚本
        cat > wine-package/bin/wine << 'EOF'
        #!/bin/bash
        # 真正的 WOW64 Wine for Termux 启动脚本
        
        export TERMUX_PREFIX="/data/data/com.termux/files/usr"
        export HOME="$HOME"
        
        # 设置临时目录 - 使用正确的 Termux tmp 路径
        export TMPDIR="$TERMUX_PREFIX/tmp"
        export TEMP="$TMPDIR"
        export TMP="$TMPDIR"
        mkdir -p "$TMPDIR" 2>/dev/null
        
        # 设置 Wine 前缀
        if [ -z "$WINEPREFIX" ]; then
            export WINEPREFIX="$HOME/.wine"
        fi
        mkdir -p "$WINEPREFIX" 2>/dev/null
        
        # 设置库路径 - 包含 32 位和 64 位库路径
        export LD_LIBRARY_PATH="$TERMUX_PREFIX/opt/wine/lib:$TERMUX_PREFIX/opt/wine/lib64:$TERMUX_PREFIX/opt/wine/lib32:$TERMUX_PREFIX/lib:$LD_LIBRARY_PATH"
        
        # 设置 Vulkan
        export VK_ICD_FILENAMES="$TERMUX_PREFIX/share/vulkan/icd.d/freedreno_icd.aarch64.json"
        
        # 设置 GStreamer
        export GST_PLUGIN_SYSTEM_PATH="$TERMUX_PREFIX/lib/gstreamer-1.0"
        export GST_PLUGIN_PATH="$TERMUX_PREFIX/lib/gstreamer-1.0"
        
        # 设置字体
        export FONTCONFIG_PATH="$TERMUX_PREFIX/opt/wine/etc/fonts"
        export FONTCONFIG_FILE="$FONTCONFIG_PATH/fonts.conf"
        
        # 设置 Wine 路径 - 包含 32 位和 64 位 DLL 路径
        export WINEDLLPATH="$TERMUX_PREFIX/opt/wine/lib/wine:$TERMUX_PREFIX/opt/wine/lib64/wine:$TERMUX_PREFIX/opt/wine/lib32/wine"
        
        # 检测架构并设置 WINEARCH
        if [ -z "$WINEARCH" ]; then
            # 如果没有指定架构，自动检测
            if file "$1" 2>/dev/null | grep -q "PE32+"; then
                export WINEARCH="win64"
            elif file "$1" 2>/dev/null | grep -q "PE32"; then
                export WINEARCH="win32"
            else
                # 默认使用 64 位
                export WINEARCH="win64"
            fi
        fi
        
        # 中文环境
        export LANG="zh_CN.UTF-8"
        export LC_ALL="zh_CN.UTF-8"
        export LC_CTYPE="zh_CN.UTF-8"
        
        # 根据架构选择运行方式
        case "$WINEARCH" in
            win32)
                echo "运行 32 位模式"
                # 如果有 32 位 wine，使用它
                if [ -f "$TERMUX_PREFIX/opt/wine/bin32/wine" ]; then
                    exec "$TERMUX_PREFIX/opt/wine/bin32/wine" "$@"
                else
                    # 否则使用 64 位 wine 运行 32 位程序
                    exec "$TERMUX_PREFIX/opt/wine/bin/wine" "$@"
                fi
                ;;
            win64|*)
                echo "运行 64 位模式"
                exec "$TERMUX_PREFIX/opt/wine/bin/wine" "$@"
                ;;
        esac
        EOF
        
        # 创建 wineserver 包装脚本
        cat > wine-package/bin/wineserver << 'EOF'
        #!/bin/bash
        export TERMUX_PREFIX="/data/data/com.termux/files/usr"
        export TMPDIR="$TERMUX_PREFIX/tmp"
        export LD_LIBRARY_PATH="$TERMUX_PREFIX/opt/wine/lib:$TERMUX_PREFIX/opt/wine/lib64:$TERMUX_PREFIX/opt/wine/lib32:$TERMUX_PREFIX/lib:$LD_LIBRARY_PATH"
        export WINEDLLPATH="$TERMUX_PREFIX/opt/wine/lib/wine:$TERMUX_PREFIX/opt/wine/lib64/wine:$TERMUX_PREFIX/opt/wine/lib32/wine"
        exec "$TERMUX_PREFIX/opt/wine/bin/wineserver" "$@"
        EOF
        
        # 创建架构选择脚本
        cat > wine-package/bin/wine32 << 'EOF'
        #!/bin/bash
        export WINEARCH="win32"
        exec wine "$@"
        EOF
        
        cat > wine-package/bin/wine64 << 'EOF'
        #!/bin/bash
        export WINEARCH="win64"
        exec wine "$@"
        EOF
        
        chmod +x wine-package/bin/wine
        chmod +x wine-package/bin/wineserver
        chmod +x wine-package/bin/wine32
        chmod +x wine-package/bin/wine64

    - name: 创建配置文件和安装脚本
      run: |
        # 创建字体配置
        mkdir -p wine-package/opt/wine/etc/fonts
        cat > wine-package/opt/wine/etc/fonts/fonts.conf << 'EOF'
        <?xml version="1.0"?>
        <!DOCTYPE fontconfig SYSTEM "fonts.dtd">
        <fontconfig>
            <dir>/data/data/com.termux/files/usr/share/fonts</dir>
            <dir>/system/fonts</dir>
            <alias>
                <family>serif</family>
                <prefer>
                    <family>Source Han Serif SC</family>
                    <family>Noto Serif CJK SC</family>
                    <family>DejaVu Serif</family>
                </prefer>
            </alias>
            <alias>
                <family>sans-serif</family>
                <prefer>
                    <family>Source Han Sans SC</family>
                    <family>Noto Sans CJK SC</family>
                    <family>DejaVu Sans</family>
                </prefer>
            </alias>
        </fontconfig>
        EOF
        
        # 创建安装脚本
        cat > wine-package/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "真正的 WOW64 Wine for Termux 安装脚本"
        
        TERMUX_PREFIX="/data/data/com.termux/files/usr"
        INSTALL_DIR="$TERMUX_PREFIX/opt/wine"
        BIN_DIR="$TERMUX_PREFIX/bin"
        FONT_DIR="$TERMUX_PREFIX/share/fonts"
        
        # 创建目录 - 确保使用正确的 tmp 路径
        mkdir -p "$INSTALL_DIR" "$BIN_DIR" "$FONT_DIR" "$TERMUX_PREFIX/tmp" "$HOME/.wine"
        
        # 安装文件
        cp -r opt/wine/* "$INSTALL_DIR"/
        cp bin/wine "$BIN_DIR"/
        cp bin/wineserver "$BIN_DIR"/
        cp bin/wine32 "$BIN_DIR"/ 2>/dev/null || true
        cp bin/wine64 "$BIN_DIR"/ 2>/dev/null || true
        cp share/fonts/* "$FONT_DIR"/ 2>/dev/null || true
        
        chmod +x "$BIN_DIR"/wine "$BIN_DIR"/wineserver "$BIN_DIR"/wine32 "$BIN_DIR"/wine64 2>/dev/null
        
        # 配置环境
        if ! grep -q "WOW64 Wine" "$HOME/.bashrc" 2>/dev/null; then
            cat >> "$HOME/.bashrc" << 'EOL'

            # WOW64 Wine 环境配置
            export TERMUX_PREFIX="/data/data/com.termux/files/usr"
            export WINEPREFIX="$HOME/.wine"
            export PATH="$PATH:$TERMUX_PREFIX/opt/wine/bin"
            export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$TERMUX_PREFIX/opt/wine/lib:$TERMUX_PREFIX/opt/wine/lib64:$TERMUX_PREFIX/opt/wine/lib32"
            export WINEDLLPATH="$TERMUX_PREFIX/opt/wine/lib/wine:$TERMUX_PREFIX/opt/wine/lib64/wine:$TERMUX_PREFIX/opt/wine/lib32/wine"
            export TMPDIR="$TERMUX_PREFIX/tmp"
            export TEMP="$TMPDIR"
            export TMP="$TMPDIR"
            export LANG="zh_CN.UTF-8"
            export FONTCONFIG_PATH="$TERMUX_PREFIX/opt/wine/etc/fonts"
            EOL
        fi
        
        echo "安装完成！请重新启动 Termux 或运行: source ~/.bashrc"
        echo "然后运行以下命令初始化 Wine:"
        echo "  wine64 wineboot  # 初始化 64 位 Wine"
        echo "  wine32 wineboot  # 初始化 32 位 Wine (如果支持)"
        echo ""
        echo "使用说明:"
        echo "  wine <程序>     # 自动检测架构"
        echo "  wine32 <程序>   # 强制 32 位模式"
        echo "  wine64 <程序>   # 强制 64 位模式"
        EOF
        
        chmod +x wine-package/install.sh

    - name: 获取版本信息
      run: |
        cd wine
        WINE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "9.0")
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "WINE_VERSION=${WINE_VERSION}-${COMMIT_HASH}-real-wow64" >> $GITHUB_ENV
        echo "构建版本: ${WINE_VERSION}-${COMMIT_HASH}-real-wow64"

    - name: 打包构建产物
      run: |
        # 打包
        tar -czf wine-${{ env.WINE_VERSION }}-termux.tar.gz wine-package/
        echo "打包完成:"
        ls -lh wine-*.tar.gz

    - name: 上传构建产物到 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wine-wow64-termux-${{ env.WINE_VERSION }}
        path: wine-${{ env.WINE_VERSION }}-termux.tar.gz

    - name: 发布到 GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: wine-wow64-${{ env.WINE_VERSION }}
        name: Wine WOW64 ${{ env.WINE_VERSION }} for Termux
        files: wine-${{ env.WINE_VERSION }}-termux.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 输出构建信息
      run: |
        echo "✅ 真正的 WOW64 Wine 构建完成"
        echo "版本: ${{ env.WINE_VERSION }}"
        echo "架构: x86_64 WOW64 (真正的 64 位支持 32 位应用)"
        echo "特性:"
        echo "✓ 真正的 WOW64 架构"
        echo "✓ 自动检测 PE 文件架构"
        echo "✓ 手动架构选择 (wine32/wine64)"
        echo "✓ DXGI 管理器补丁 (通过环境变量控制)"
        echo "✓ esync 补丁"
        echo "✓ Termux 路径修复 (正确的 tmp 路径)"
        echo "✓ Vulkan 支持"
        echo "✓ GStreamer 完整支持"
        echo "✓ X11 图形支持"
        echo "✓ ALSA/PulseAudio 音频支持"
        echo "✓ CUPS 打印支持"
        echo "✓ DBus 支持"
        echo "✓ 中文环境和字体"
        echo ""
        echo "使用说明:"
        echo "1. 下载 wine-${{ env.WINE_VERSION }}-termux.tar.gz"
        echo "2. 解压: tar -xzf wine-*.tar.gz"
        echo "3. 进入目录: cd wine-package"
        echo "4. 运行安装: ./install.sh"
        echo "5. 重新加载环境: source ~/.bashrc"
        echo "6. 初始化:"
        echo "   wine64 wineboot  # 初始化 64 位 Wine"
        echo "   wine32 wineboot  # 初始化 32 位 Wine (如果支持)"
        echo ""
        echo "运行程序:"
        echo "  wine <程序>     # 自动检测架构"
        echo "  wine32 <程序>   # 强制 32 位模式"
        echo "  wine64 <程序>   # 强制 64 位模式"
        echo ""
        echo "注意: 如需禁用 DXGI 设备管理器，请设置环境变量:"
        echo "export WINE_DO_NOT_CREATE_DXGI_DEVICE_MANAGER=1"
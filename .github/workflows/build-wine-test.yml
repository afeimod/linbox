# build-wine-test.yml
name: Build TestWine (True WOW64 for Termux with Bootstrap)

on:
  workflow_dispatch:
    inputs:
      wine_version:
        description: 'Wine 版本号 (例如: 9.9, 9.21, 9.22)'
        required: true
        default: '9.21'
        type: string
      use_bootstrap:
        description: '使用 Bootstrap 环境构建（减少内存占用）'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      WINE_VERSION: ${{ github.event.inputs.wine_version }}
      USE_BOOTSTRAP: ${{ github.event.inputs.use_bootstrap }}

    steps:
    - name: 检查输入参数
      run: |
        echo "Wine 版本: ${{ env.WINE_VERSION }}"
        echo "使用 Bootstrap: ${{ env.USE_BOOTSTRAP }}"

    - name: 安装基础依赖
      run: |
        sudo apt update
        sudo apt install -y \
          git wget xz-utils \
          autoconf flex bison \
          make cmake ninja-build \
          gcc g++ gcc-multilib g++-multilib \
          mingw-w64 \
          gettext libgettextpo-dev \
          locales language-pack-zh-hans \
          ccache

    - name: 设置中文环境
      run: |
        sudo locale-gen zh_CN.UTF-8
        sudo update-locale LANG=zh_CN.UTF-8
        export LANG=zh_CN.UTF-8
        export LC_ALL=zh_CN.UTF-8

    - name: 创建完整的 Bootstrap 环境
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "创建完整的 Bootstrap 环境..."
        sudo apt install -y debootstrap bubblewrap
        
        # 创建引导目录
        sudo mkdir -p /opt/chroots/ubuntu64_chroot
        
        # 创建完整的 Ubuntu 22.04 环境（非最小化）
        echo "创建完整的 Ubuntu 22.04 环境..."
        sudo debootstrap --arch=amd64 jammy /opt/chroots/ubuntu64_chroot http://archive.ubuntu.com/ubuntu/
        
        # 在引导环境中配置基本的 apt 源和更新
        echo "配置引导环境的软件源..."
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          # 添加 universe 和 multiverse 仓库
          echo 'deb http://archive.ubuntu.com/ubuntu jammy main universe multiverse' > /etc/apt/sources.list
          echo 'deb http://archive.ubuntu.com/ubuntu jammy-updates main universe multiverse' >> /etc/apt/sources.list
          echo 'deb http://archive.ubuntu.com/ubuntu jammy-security main universe multiverse' >> /etc/apt/sources.list
          
          # 更新软件包列表
          apt update
          
          # 安装基本系统工具
          apt install -y software-properties-common apt-utils
          
          # 更新整个系统
          apt upgrade -y
        "
        
        # 在引导环境中安装完整的构建工具链
        echo "在引导环境中安装完整的构建工具链..."
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          # 更新软件包列表
          apt update
          
          # 安装完整的开发工具链
          apt install -y \
            build-essential \
            gcc g++ gcc-multilib g++-multilib \
            mingw-w64 mingw-w64-tools \
            autoconf automake flex bison \
            libtool pkg-config \
            cmake ninja-build \
            meson nasm yasm \
            && echo '✅ 基础开发工具安装完成'
          
          # 安装完整的 X11 开发包
          echo '安装完整的 X11 开发包...'
          apt install -y \
            libx11-dev libx11-xcb-dev \
            libxext-dev libxi-dev \
            libxrandr-dev libxcursor-dev libxcomposite-dev \
            libxdamage-dev libxfixes-dev libxxf86vm-dev \
            libxrender-dev libxinerama-dev \
            libxtst-dev libxss-dev \
            libxcb1-dev libxcb-*-dev \
            x11proto-core-dev x11proto-xext-dev \
            x11proto-xf86vidmode-dev x11proto-xinerama-dev \
            x11proto-randr-dev x11proto-record-dev \
            x11proto-scrnsaver-dev x11proto-video-dev \
            && echo '✅ X11 开发包安装完成'
          
          # 安装 OpenGL 和 Vulkan 开发包
          apt install -y \
            libgl-dev libglu-dev libosmesa6-dev \
            libglvnd-dev \
            libvulkan-dev vulkan-tools libvulkan1 mesa-vulkan-drivers \
            && echo '✅ OpenGL/Vulkan 开发包安装完成'
          
          # 安装完整的字体和多媒体开发包
          apt install -y \
            libfreetype6-dev libfontconfig1-dev libfribidi-dev \
            libharfbuzz-dev libharfbuzz-icu0 libharfbuzz-gobject0 \
            libpng-dev libjpeg-dev libtiff-dev \
            libgif-dev libwebp-dev \
            && echo '✅ 字体和图像开发包安装完成'
          
          # 安装音频开发包
          apt install -y \
            libasound2-dev libpulse-dev \
            libopenal-dev libaudio-dev \
            libsndfile1-dev libsoxr-dev \
            && echo '✅ 音频开发包安装完成'
          
          # 安装网络和安全开发包
          apt install -y \
            libssl-dev libgnutls28-dev \
            libpcap-dev libnet1-dev \
            libldap2-dev libsasl2-dev \
            && echo '✅ 网络和安全开发包安装完成'
          
          # 安装多媒体开发包
          apt install -y \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav gstreamer1.0-tools \
            libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libpostproc-dev \
            libmpg123-dev libvorbis-dev libflac-dev \
            && echo '✅ 多媒体开发包安装完成'
          
          # 安装其他 Wine 构建依赖
          apt install -y \
            libdbus-1-dev libudev-dev \
            libcups2-dev libcairo2-dev \
            libpango1.0-dev libgdk-pixbuf2.0-dev \
            libatk1.0-dev libgtk-3-dev \
            libxml2-dev libxslt1-dev \
            libncurses5-dev libreadline-dev \
            libbz2-dev liblzma-dev \
            libgcrypt20-dev libgpg-error-dev \
            libsystemd-dev libkrb5-dev \
            libsane-dev libcapi20-dev libgsm1-dev \
            liblcms2-dev libmp3lame-dev \
            libopencl-dev libva-dev libvdpau-dev \
            libegl1-mesa-dev libgles2-mesa-dev \
            libgbm-dev libdrm-dev \
            libjack-dev libportaudio2 portaudio19-dev \
            libusb-1.0-0-dev libpciaccess-dev \
            libunwind-dev libcap-dev \
            libattr1-dev libacl1-dev \
            libblkid-dev libmount-dev \
            libselinux1-dev libsepol-dev \
            libffi-dev libpcre3-dev \
            libzstd-dev liblz4-dev \
            libsnappy-dev libbz2-dev \
            libjson-c-dev libyajl-dev \
            libcurl4-openssl-dev libssh2-1-dev \
            libpq-dev libmysqlclient-dev \
            libsqlite3-dev libodbc1-dev \
            libpq5 libmysqlclient21 \
            && echo '✅ 其他 Wine 依赖安装完成'
          
          # 安装语言和区域支持
          apt install -y \
            locales language-pack-zh-hans \
            gettext libgettextpo-dev \
            && echo '✅ 语言支持安装完成'
          
          # 清理缓存
          apt clean
          rm -rf /var/lib/apt/lists/*
          
          # 验证安装
          echo '=== 验证安装 ==='
          gcc --version
          g++ --version
          x86_64-w64-mingw32-gcc --version
          i686-w64-mingw32-gcc --version
          pkg-config --version
          echo 'X11 库检查:'
          pkg-config --list-all | grep -i x11 | head -10
          echo 'FreeType 检查:'
          pkg-config --modversion freetype2 || echo 'FreeType 未找到'
          echo 'FontConfig 检查:'
          pkg-config --modversion fontconfig || echo 'FontConfig 未找到'
          echo '=== 验证完成 ==='
        "
        
        echo "✅ 完整的 Bootstrap 环境准备完成"

    - name: 克隆 Wine 源码
      run: |
        git clone https://github.com/wine-mirror/wine.git
        cd wine
        git checkout wine-${{ env.WINE_VERSION }}
        echo "Wine 源码版本: ${{ env.WINE_VERSION }}"

    - name: 下载并应用 Staging 补丁
      run: |
        cd wine
        # 下载 staging 补丁集
        wget -O wine-staging-${{ env.WINE_VERSION }}.tar.gz https://github.com/wine-staging/wine-staging/archive/refs/tags/v${{ env.WINE_VERSION }}.tar.gz
        tar -xzf wine-staging-${{ env.WINE_VERSION }}.tar.gz
        
        # 应用 staging 补丁
        cd wine-staging-${{ env.WINE_VERSION }}/staging
        chmod +x patchinstall.py
        ./patchinstall.py --all --destdir=../../
        echo "✅ Staging 补丁应用完成"

    - name: 应用 MF 兼容性补丁
      run: |
        cd wine
        
        # 解析版本号确定补丁类型
        VERSION_MAJOR=$(echo "${{ env.WINE_VERSION }}" | cut -d. -f1)
        VERSION_MINOR=$(echo "${{ env.WINE_VERSION }}" | cut -d. -f2)
        
        echo "Wine 版本: ${{ env.WINE_VERSION }}"
        echo "主版本: $VERSION_MAJOR, 次版本: $VERSION_MINOR"
        
        # 判断版本并应用相应补丁
        if [ $VERSION_MAJOR -gt 9 ] || [ $VERSION_MAJOR -eq 9 -a $VERSION_MINOR -ge 10 ]; then
            echo "应用 9.10+ 版本的 MF 修复补丁"
            wget https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
            if [ -f "dlls/mfplat/main.c" ]; then
                patch -p1 < wine_do_not_create_dxgi_manager2.patch && echo "✅ 补丁应用成功"
            else
                echo "⚠️ 目标文件不存在，跳过补丁"
            fi
        else
            echo "应用 9.10 以下版本的 MF 修复脚本"
            wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
            chmod +x fix_wine9.2_mfplat.sh
            ./fix_wine9.2_mfplat.sh && echo "✅ 修复脚本执行完成"
        fi

    - name: 修复 Termux 路径问题
      run: |
        cd wine
        echo "修复 Termux 路径问题..."
        
        # 修改硬编码的 /tmp 路径为 Termux 路径
        find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | \
          xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g' || true
        
        # 修复关键文件中的路径
        find server -type f \( -name "*.c" -o -name "*.h" \) -exec \
          sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} + || true
        
        echo "路径修复完成"

    - name: 复制源码到 Bootstrap 环境并验证
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "复制 Wine 源码到 Bootstrap 环境..."
        
        # 清理之前的源码（如果有）
        sudo rm -rf /opt/chroots/ubuntu64_chroot/opt/wine
        
        # 复制源码到 Bootstrap 环境
        sudo cp -r wine /opt/chroots/ubuntu64_chroot/opt/
        
        # 验证复制是否成功
        echo "验证源码复制:"
        sudo ls -la /opt/chroots/ubuntu64_chroot/opt/wine/ | head -10
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "ls -la /opt/wine/" | head -10
        
        echo "✅ 源码复制完成"

    - name: 配置前的依赖检查
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "在 Bootstrap 环境中检查关键依赖..."
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          echo '=== 关键依赖检查 ==='
          echo 'FreeType:'
          pkg-config --modversion freetype2 || echo 'FreeType 未找到'
          echo 'FontConfig:'
          pkg-config --modversion fontconfig || echo 'FontConfig 未找到'
          echo 'X11:'
          pkg-config --modversion x11 || echo 'X11 未找到'
          echo 'OpenGL:'
          pkg-config --modversion gl || echo 'OpenGL 未找到'
          echo 'Vulkan:'
          pkg-config --modversion vulkan || echo 'Vulkan 未找到'
          echo 'GStreamer:'
          pkg-config --modversion gstreamer-1.0 || echo 'GStreamer 未找到'
          echo 'ALSA:'
          pkg-config --modversion alsa || echo 'ALSA 未找到'
          echo 'PulseAudio:'
          pkg-config --modversion libpulse || echo 'PulseAudio 未找到'
          echo '=== 检查完成 ==='
        "

    - name: 配置 Wine 构建（Bootstrap 模式 - 修复版）
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "在 Bootstrap 环境中配置 Wine..."
        
        # 使用 chroot 配置
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          set -e
          echo '当前目录: $(pwd)'
          echo '切换到 Wine 源码目录...'
          cd /opt/wine
          echo '当前目录: $(pwd)'
          
          echo '创建构建目录...'
          mkdir -p build-wow64
          cd build-wow64
          echo '构建目录: $(pwd)'
          
          echo '开始配置 Wine 构建...'
          # 显示配置命令
          echo '运行配置命令: ../configure ...'
          
          # 运行配置
          ../configure \
            --enable-win64 \
            --enable-archs=i386,x86_64 \
            --prefix=/tmp/wine-install \
            --with-x \
            --with-vulkan \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-dbus \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-cups \
            --without-capi \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-oss \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland
            
          echo '✅ Bootstrap 环境配置完成'
          
          # 验证 Makefile 是否生成
          echo '验证 Makefile:'
          ls -la Makefile || echo 'Makefile 不存在'
          if [ -f 'Makefile' ]; then
            echo '✅ Makefile 已生成'
          else
            echo '❌ Makefile 未生成，配置失败'
            exit 1
          fi
        "

    - name: 配置 Wine 构建（直接模式）
      if: env.USE_BOOTSTRAP == 'false'
      run: |
        cd wine
        echo "当前目录: $(pwd)"
        
        # 安装宿主系统的所有必要开发包
        echo "安装宿主系统的所有必要开发包..."
        sudo apt update
        sudo apt install -y \
          libx11-dev libx11-xcb-dev \
          libxext-dev libxi-dev \
          libxrandr-dev libxcursor-dev libxcomposite-dev \
          libxdamage-dev libxfixes-dev libxxf86vm-dev \
          libxrender-dev libxinerama-dev \
          libxtst-dev libxss-dev \
          libxcb1-dev libxcb-*-dev \
          x11proto-core-dev x11proto-xext-dev \
          x11proto-xf86vidmode-dev x11proto-xinerama-dev \
          x11proto-randr-dev x11proto-record-dev \
          x11proto-scrnsaver-dev x11proto-video-dev \
          libgl-dev libglu-dev libosmesa6-dev \
          libglvnd-dev \
          libvulkan-dev vulkan-tools libvulkan1 mesa-vulkan-drivers \
          libfreetype6-dev libfontconfig1-dev libfribidi-dev \
          libharfbuzz-dev libharfbuzz-icu0 libharfbuzz-gobject0 \
          libpng-dev libjpeg-dev libtiff-dev \
          libgif-dev libwebp-dev \
          libasound2-dev libpulse-dev \
          libopenal-dev libaudio-dev \
          libsndfile1-dev libsoxr-dev \
          libssl-dev libgnutls28-dev \
          libpcap-dev libnet1-dev \
          libldap2-dev libsasl2-dev \
          libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
          gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
          gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
          gstreamer1.0-libav gstreamer1.0-tools \
          libavcodec-dev libavformat-dev libavutil-dev \
          libswscale-dev libpostproc-dev \
          libmpg123-dev libvorbis-dev libflac-dev \
          libdbus-1-dev libudev-dev \
          libcups2-dev libcairo2-dev \
          libpango1.0-dev libgdk-pixbuf2.0-dev \
          libatk1.0-dev libgtk-3-dev \
          libxml2-dev libxslt1-dev \
          libncurses5-dev libreadline-dev \
          libbz2-dev liblzma-dev \
          libgcrypt20-dev libgpg-error-dev \
          libsystemd-dev libkrb5-dev \
          libsane-dev libcapi20-dev libgsm1-dev \
          liblcms2-dev libmp3lame-dev \
          libopencl-dev libva-dev libvdpau-dev \
          libegl1-mesa-dev libgles2-mesa-dev \
          libgbm-dev libdrm-dev \
          libjack-dev libportaudio2 portaudio19-dev \
          libusb-1.0-0-dev libpciaccess-dev \
          libunwind-dev libcap-dev \
          libattr1-dev libacl1-dev \
          libblkid-dev libmount-dev \
          libselinux1-dev libsepol-dev \
          libffi-dev libpcre3-dev \
          libzstd-dev liblz4-dev \
          libsnappy-dev libbz2-dev \
          libjson-c-dev libyajl-dev \
          libcurl4-openssl-dev libssh2-1-dev \
          libpq-dev libmysqlclient-dev \
          libsqlite3-dev libodbc1-dev
        
        mkdir -p build-wow64
        cd build-wow64
        
        echo "构建目录: $(pwd)"
        
        # 直接配置（不使用 Bootstrap）
        ../configure \
          --enable-win64 \
          --enable-archs=i386,x86_64 \
          --prefix=/tmp/wine-install \
          --with-x \
          --with-vulkan \
          --with-alsa \
          --with-pulse \
          --with-freetype \
          --with-fontconfig \
          --with-gstreamer \
          --with-gettext \
          --enable-nls \
          --disable-winemenubuilder \
          --disable-win16 \
          --disable-tests \
          --without-dbus \
          --without-sane \
          --without-pcap \
          --without-pcsclite \
          --without-cups \
          --without-capi \
          --without-coreaudio \
          --without-gphoto \
          --without-osmesa \
          --without-oss \
          --without-udev \
          --without-unwind \
          --without-usb \
          --without-v4l2 \
          --without-wayland
        
        echo "✅ 直接模式配置完成"
        
        # 验证 Makefile
        echo "验证 Makefile:"
        ls -la Makefile || echo "Makefile 不存在"
        if [ -f 'Makefile' ]; then
          echo '✅ Makefile 已生成'
        else
          echo '❌ Makefile 未生成，配置失败'
          exit 1
        fi

    - name: 编译 Wine（Bootstrap 模式）
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "在 Bootstrap 环境中编译 Wine..."
        
        # 首先验证构建目录状态
        echo "验证构建目录状态:"
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          cd /opt/wine/build-wow64
          echo '构建目录: $(pwd)'
          ls -la | head -10
          echo '检查 Makefile:'
          if [ -f 'Makefile' ]; then
            echo '✅ Makefile 存在，开始编译...'
          else
            echo '❌ Makefile 不存在，无法编译'
            exit 1
          fi
        "
        
        # 使用 chroot 编译
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          set -e
          cd /opt/wine/build-wow64
          echo '开始编译 Wine...'
          echo '使用线程数: $(nproc)'
          
          # 显示编译进度
          make -j$(nproc) V=1 || make V=1
          echo '✅ Bootstrap 环境编译完成'
        "

    - name: 编译 Wine（直接模式）
      if: env.USE_BOOTSTRAP == 'false'
      run: |
        cd wine/build-wow64
        echo "开始编译 Wine..."
        echo "当前目录: $(pwd)"
        echo "使用线程数: $(nproc)"
        
        # 验证 Makefile
        if [ ! -f 'Makefile' ]; then
          echo "❌ Makefile 不存在，无法编译"
          exit 1
        fi
        
        # 使用多线程编译
        make -j$(nproc) V=1 || make V=1
        echo "✅ 编译完成"

    - name: 安装 Wine（Bootstrap 模式）
      if: env.USE_BOOTSTRAP == 'true'
      run: |
        echo "在 Bootstrap 环境中安装 Wine..."
        
        # 使用 chroot 安装
        sudo chroot /opt/chroots/ubuntu64_chroot /bin/bash -c "
          set -e
          cd /opt/wine/build-wow64
          echo '开始安装 Wine...'
          make install
          echo '✅ Bootstrap 环境安装完成'
          
          # 显示安装文件大小
          echo '安装目录大小:'
          du -sh /tmp/wine-install/
          
          # 验证安装
          echo '验证安装:'
          ls -la /tmp/wine-install/bin/ | head -10
        "
        
        # 将安装文件从 chroot 环境复制到主机
        echo "复制安装文件到主机..."
        sudo cp -r /opt/chroots/ubuntu64_chroot/tmp/wine-install /tmp/
        sudo chown -R $USER:$USER /tmp/wine-install
        
        echo "验证主机上的安装文件:"
        ls -la /tmp/wine-install/bin/ | head -10

    - name: 安装 Wine（直接模式）
      if: env.USE_BOOTSTRAP == 'false'
      run: |
        cd wine/build-wow64
        make install
        echo "✅ Wine 安装完成"
        
        # 显示安装文件大小
        echo "安装目录大小:"
        du -sh /tmp/wine-install/
        
        # 验证安装
        echo "验证安装:"
        ls -la /tmp/wine-install/bin/ | head -10

    - name: 验证构建结果
      run: |
        echo "验证构建结果..."
        
        # 检查关键文件
        if [ -f "/tmp/wine-install/bin/wine" ]; then
            echo "✅ Wine 二进制文件存在"
            /tmp/wine-install/bin/wine --version || true
        else
            echo "❌ 错误: Wine 二进制文件不存在"
            exit 1
        fi
        
        # 检查 WoW64 支持
        echo "WoW64 支持检查:"
        find /tmp/wine-install -name "*wine*" -type f | grep -E "(bin|lib)" | head -10
        
        # 检查目录结构
        echo "安装目录结构:"
        ls -la /tmp/wine-install/
        echo "bin 目录:"
        ls -la /tmp/wine-install/bin/
        echo "lib 目录:"
        ls -la /tmp/wine-install/lib/ | head -10

    - name: 准备打包
      run: |
        # 创建打包目录结构
        mkdir -p wine-package/opt/wine
        mkdir -p wine-package/usr/local/bin
        
        # 复制 Wine 文件
        cp -r /tmp/wine-install/* wine-package/opt/wine/
        
        # 创建启动脚本
        cat > wine-package/usr/local/bin/wine << 'EOF'
            #!/bin/bash
            export WINEPREFIX=${WINEPREFIX:-$HOME/.wine}
            export WINEARCH=${WINEARCH:-win64}
            /opt/wine/bin/wine "$@"
        EOF
        chmod +x wine-package/usr/local/bin/wine
        
        # 创建版本信息文件
        if [ "${{ env.USE_BOOTSTRAP }}" = "true" ]; then
            BUILD_TYPE="Bootstrap (Full Ubuntu)"
        else
            BUILD_TYPE="Direct"
        fi
        
        cat > wine-package/version-info.txt << EOF
            Wine Version: ${{ env.WINE_VERSION }}
            Build Date: $(date)
            Build Type: $BUILD_TYPE
            Architecture: True WOW64 (i386/x86_64)
            Platform: Termux
            Features: Vulkan, GStreamer, True WOW64
            Bootstrap Environment: Full Ubuntu 22.04 with all development tools
        EOF

        echo "打包目录结构:"
        find wine-package -type f | head -20

    - name: 创建压缩包
      run: |
        # 确定构建类型标签
        if [ "${{ env.USE_BOOTSTRAP }}" = "true" ]; then
            BUILD_TYPE="bootstrap-full"
        else
            BUILD_TYPE="direct"
        fi
        
        # 创建压缩包
        tar -czf wine-${{ env.WINE_VERSION }}-wow64-$BUILD_TYPE-termux.tar.gz wine-package/
        
        echo "打包完成:"
        ls -lh wine-*.tar.gz
        echo ""
        echo "压缩包内容:"
        tar -tzf wine-${{ env.WINE_VERSION }}-wow64-$BUILD_TYPE-termux.tar.gz | head -20

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: wine-${{ env.WINE_VERSION }}-wow64-${{ env.USE_BOOTSTRAP && 'bootstrap-full' || 'direct' }}-termux
        path: wine-${{ env.WINE_VERSION }}-wow64-*-termux.tar.gz
        retention-days: 30

    - name: 发布到 GitHub Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: wine-${{ env.WINE_VERSION }}-wow64-${{ env.USE_BOOTSTRAP && 'bootstrap-full' || 'direct' }}
        name: Wine ${{ env.WINE_VERSION }} (WOW64 for Termux)
        body: |
          # Wine ${{ env.WINE_VERSION }} - True WOW64 for Termux
          
          ## 构建信息
          - **版本**: ${{ env.WINE_VERSION }}
          - **架构**: True WOW64 (同时支持 32/64 位)
          - **构建模式**: ${{ env.USE_BOOTSTRAP && 'Bootstrap (完整 Ubuntu 环境)' || 'Direct' }}
          - **平台**: Termux (Android)
          - **特性**: Vulkan, GStreamer, True WOW64
          
          ## 主要改进
          ✓ 真正的 WOW64 架构支持
          ✓ Vulkan 图形 API 支持
          ✓ GStreamer 多媒体支持  
          ✓ Termux 路径兼容性修复
          ✓ MF 兼容性补丁
          ✓ ${{ env.USE_BOOTSTRAP && '完整 Ubuntu Bootstrap 环境构建' || '直接构建' }}
          
          ## 使用说明
          1. 解压到 Termux 环境
          2. 添加 `/opt/wine/bin` 到 PATH
          3. 运行 `wine --version` 测试
          
          ## 构建详情
          - 构建时间: ${{ github.event.head_commit.timestamp }}
          - 提交: ${{ github.sha }}
          - 工作流: ${{ github.workflow }}
        files: wine-${{ env.WINE_VERSION }}-wow64-*-termux.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 输出构建摘要
      run: |
        echo "=== 构建摘要 ==="
        echo "✅ Wine 构建完成"
        echo "版本: ${{ env.WINE_VERSION }}"
        echo "架构: True WOW64 (i386/x86_64)"
        echo "构建模式: ${{ env.USE_BOOTSTRAP && 'Bootstrap（完整 Ubuntu 环境）' || 'Direct（直接）' }}"
        echo "平台: Termux"
        echo ""
        echo "包含特性:"
        echo "✓ Vulkan 图形支持"
        echo "✓ GStreamer 多媒体支持"
        echo "✓ Termux 路径兼容性"
        echo "✓ MF 兼容性修复"
        echo "✓ 完整开发工具链"
        echo "✓ 完整的 X11 支持"
        echo "✓ 完整的 FreeType 和字体支持"
        echo "✓ 完整的音频支持"
        echo "✓ 完整的网络支持"
        echo ""
        echo "构建产物: wine-${{ env.WINE_VERSION }}-wow64-${{ env.USE_BOOTSTRAP && 'bootstrap-full' || 'direct' }}-termux.tar.gz"
        echo "================"
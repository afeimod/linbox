# build-mesaglibc.yml
name: Build Mesa glibc(Multi-arch)

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa åˆ†æ”¯/æ ‡ç­¾/æäº¤ (ä¾‹å¦‚: main, 24.3, 24.4.0, adreno-main)'
        required: false
        default: 'adreno-main'
        type: string
      use_upstream:
        description: 'æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa (è€Œä¸æ˜¯ lfdevs çš„åˆ†æ”¯)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„'
        required: false
        default: 'both'
        type: choice
        options:
          - 'aarch64'
          - 'arm-linux-gnueabihf'
          - 'both'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: è®¾ç½®æ„å»ºå‚æ•°
      id: setup
      run: |
        # è®¾ç½®é»˜è®¤å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "MESA_BRANCH=${{ github.event.inputs.mesa_branch || 'adreno-main' }}" >> $GITHUB_ENV
          echo "USE_UPSTREAM=${{ github.event.inputs.use_upstream || 'false' }}" >> $GITHUB_ENV
          echo "TARGET_ARCH=${{ github.event.inputs.target_arch || 'both' }}" >> $GITHUB_ENV
        else
          echo "MESA_BRANCH=adreno-main" >> $GITHUB_ENV
          echo "USE_UPSTREAM=false" >> $GITHUB_ENV
          echo "TARGET_ARCH=both" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        # è®¾ç½®å®‰è£…ç›®å½•
        echo "INSTALL_PREFIX=/data/data/com.termux/files/usr/glibc" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨çš„ Mesa åˆ†æ”¯/æ ‡ç­¾: $MESA_BRANCH"
        echo "æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸: $USE_UPSTREAM"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"
        echo "å®‰è£…ç›®å½•: $INSTALL_PREFIX"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "æ„å»ºç¯å¢ƒä¿¡æ¯:"
        uname -a
        lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
        free -h
        echo "å½“å‰æ¶æ„: $(uname -m)"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
        
        # å…ˆæ›´æ–°åŒ…åˆ—è¡¨
        sudo apt update
        
        # å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç”¨äº aarch64 æ„å»ºï¼‰
        sudo apt install -y \
          glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
          libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev \
          libxcb-present-dev libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev \
          libxshmfence-dev libdrm-dev libgbm-dev libegl1-mesa-dev libexpat1-dev \
          python3-pip python3-setuptools python3-wheel ninja-build \
          flex bison libtool libclc-20-dev pkg-config build-essential libatomic1 \
          gcc g++ make cmake
        
        # å¦‚æœåŒ…å« armhf æ„å»ºï¼Œå®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        if [ "$TARGET_ARCH" = "both" ] || [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          echo "å®‰è£… ARM äº¤å‰ç¼–è¯‘å·¥å…·é“¾..."
          
          # å¯¹äº ARM åˆ° ARM çš„äº¤å‰ç¼–è¯‘ï¼Œä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•
          # åªå®‰è£…åŸºæœ¬çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼Œä¸æ·»åŠ  armhf æ¶æ„
          sudo apt install -y \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            libc6-dev-armhf-cross \
            llvm-19-dev  # æ·»åŠ  LLVM å¼€å‘åŒ…
        
          sudo dpkg --add-architecture armhf
          sudo apt update
          sudo apt upgrade -y
          # å®‰è£… Mesa æ„å»ºæ‰€éœ€çš„æ‰€æœ‰ armhf ä¾èµ–
          # XCB ç›¸å…³ä¾èµ–
          sudo apt install -y \
            libxcb1-dev:armhf \
            libxcb-glx0-dev:armhf \
            libxcb-dri2-0-dev:armhf \
            libxcb-dri3-dev:armhf \
            libxcb-present-dev:armhf \
            libxcb-sync-dev:armhf \
            libxcb-shm0-dev:armhf \
            libxcb-xfixes0-dev:armhf \
            libxcb-randr0-dev:armhf \
            libxcb-xkb-dev:armhf
        
          # X11 ç›¸å…³ä¾èµ–
          sudo apt install -y zenity:armhf libstdc++6:armhf \
            zlib1g-dev:armhf libexpat1-dev:armhf libdrm-dev:armhf libx11-dev:armhf \
            libxext-dev:armhf libxdamage-dev:armhf libxcb-glx0-dev:armhf libx11-xcb-dev:armhf \
            libxcb-dri2-0-dev:armhf libxcb-dri3-dev:armhf libxcb-present-dev:armhf \
            libxshmfence-dev:armhf libxxf86vm-dev:armhf libxrandr-dev:armhf libwayland-dev:armhf \
            wayland-protocols:armhf libwayland-egl-backend-dev:armhf libxcb-shm0-dev:armhf \
            pkg-config:armhf libgbm-dev:armhf libegl1-mesa-dev:armhf
        
          # DRM/GBM ç›¸å…³ä¾èµ–
          sudo apt install -y \
            libdrm-dev:armhf \
            libgbm-dev:armhf \
            libegl1-mesa-dev:armhf \
            libglvnd-dev:armhf
        
          # Vulkan ç›¸å…³ä¾èµ–ï¼ˆç”¨äº freedreno vulkan é©±åŠ¨ï¼‰
          sudo apt install -y \
            libvulkan-dev:armhf \
            glslang-tools:armhf \
            vulkan-tools:armhf \
            libglvnd-core-dev:armhf \
            libglvnd-dev:armhf \
            libglvnd0:armhf
       
          echo "ARM äº¤å‰ç¼–è¯‘ç¯å¢ƒå·²å‡†å¤‡"
          sudo apt build-dep mesa -y
          sudo apt install -f -y
        fi

    - name: å®‰è£… Python æ„å»ºå·¥å…·
      run: |
        sudo pip3 install meson mako
        
        echo "æ£€æŸ¥å®‰è£…çš„ meson ç‰ˆæœ¬:"
        meson --version
        python3 -c "import mesonbuild; print('mesonbuild æ¨¡å—è·¯å¾„:', mesonbuild.__file__)"
        
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: å…‹éš† Mesa æºç 
      run: |
        echo "ğŸ“¥ å…‹éš† Mesa ä»“åº“..."
        
        if [ "$USE_UPSTREAM" = "true" ]; then
          echo "ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa ä»“åº“"
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          # æ£€å‡ºæŒ‡å®šåˆ†æ”¯/æ ‡ç­¾/æäº¤
          if [ -n "$MESA_BRANCH" ] && [ "$MESA_BRANCH" != "adreno-main" ]; then
            echo "æ£€å‡ºä¸Šæ¸¸åˆ†æ”¯/æ ‡ç­¾/æäº¤: $MESA_BRANCH"
            # é¦–å…ˆå°è¯•è·å–åˆ†æ”¯æˆ–æ ‡ç­¾
            if git fetch origin "$MESA_BRANCH" 2>/dev/null; then
              git checkout "$MESA_BRANCH"
            else
              echo "æœªæ‰¾åˆ°åˆ†æ”¯ '$MESA_BRANCH'ï¼Œå°è¯•ä½œä¸ºæ ‡ç­¾æ£€å‡º..."
              if git fetch origin --tags 2>/dev/null && git checkout "tags/$MESA_BRANCH" 2>/dev/null; then
                echo "æˆåŠŸæ£€å‡ºæ ‡ç­¾: $MESA_BRANCH"
              else
                echo "å°è¯•ä½œä¸ºæäº¤å“ˆå¸Œæ£€å‡º..."
                git checkout "$MESA_BRANCH" 2>/dev/null || {
                  echo "âŒ æ— æ³•æ£€å‡º '$MESA_BRANCH'ï¼Œè¯·æ£€æŸ¥åˆ†æ”¯/æ ‡ç­¾/æäº¤æ˜¯å¦å­˜åœ¨"
                  exit 1
                }
              fi
            fi
          else
            echo "ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa ä»“åº“çš„é»˜è®¤åˆ†æ”¯ (main)"
            git checkout main
          fi
        else
          echo "ä½¿ç”¨ lfdevs çš„ Mesa for Android Container ä»“åº“"
          git clone https://github.com/lfdevs/mesa-for-android-container.git mesa
          cd mesa
          
          # æ£€å‡ºæŒ‡å®šåˆ†æ”¯
          if [ -n "$MESA_BRANCH" ] && [ "$MESA_BRANCH" != "main" ]; then
            echo "æ£€å‡ºåˆ†æ”¯: $MESA_BRANCH"
            git checkout $MESA_BRANCH
          fi
        fi
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        GIT_HASH=$(git rev-parse --short HEAD)
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION="git-$GIT_HASH"
        fi
        
        GIT_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$GIT_HASH")
        
        echo "MESA_GIT_HASH=$GIT_HASH" >> $GITHUB_ENV
        echo "MESA_VERSION=$OFFICIAL_VERSION" >> $GITHUB_ENV
        echo "GIT_DESCRIBE=$GIT_DESCRIBE" >> $GITHUB_ENV
        echo "MESA_BRANCH_ACTUAL=$(git branch --show-current)" >> $GITHUB_ENV
        
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "ç‰ˆæœ¬: $OFFICIAL_VERSION"
        echo "æäº¤: $GIT_HASH"
        echo "æè¿°: $GIT_DESCRIBE"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo "æ ‡ç­¾/æäº¤: $(git describe --tags 2>/dev/null || echo 'æ— æ ‡ç­¾')"

    - name: æ„å»º aarch64 æ¶æ„
      if: env.TARGET_ARCH == 'aarch64' || env.TARGET_ARCH == 'both'
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º aarch64 æ¶æ„..."
        cd mesa
        
        # åˆ›å»ºå®‰è£…ç›®å½•
        sudo mkdir -p $INSTALL_PREFIX
        sudo chmod 777 -R /data/data/com.termux/files/usr/glibc
        
        # ä¸º aarch64 åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build-aarch64
        
        # é…ç½® aarch64 æ„å»º
        meson setup build-aarch64 \
            --libdir=lib \
            -Dprefix=$INSTALL_PREFIX \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno,llvmpipe \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dmediafoundation-codecs=all \
            -Dgbm=enabled
        
        echo "ğŸ—ï¸  æ­£åœ¨æ„å»º aarch64..."
        ninja -C build-aarch64 -j$(nproc)
        
        echo "ğŸ“¦ æ­£åœ¨å®‰è£… aarch64..."
        sudo ninja -C build-aarch64 install
        
        # éªŒè¯å®‰è£…
        echo "aarch64 å®‰è£…éªŒè¯:"
        ls -la $INSTALL_PREFIX/lib/
        echo "aarch64 åº“æ–‡ä»¶æ¶æ„:"
        file $INSTALL_PREFIX/lib/*.so 2>/dev/null | head -5 || true

    - name: æ„å»º arm-linux-gnueabihf æ¶æ„
      if: env.TARGET_ARCH == 'arm-linux-gnueabihf' || env.TARGET_ARCH == 'both'
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º arm-linux-gnueabihf æ¶æ„..."
        cd mesa
        
        # ç¡®ä¿å®‰è£…ç›®å½•å­˜åœ¨
        sudo mkdir -p $INSTALL_PREFIX
        sudo chmod 777 -R /data/data/com.termux/files/usr/glibc
        
        # åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
        wget -O cross-file.txt https://github.com/afeimod/linbox/raw/main/path/cross-file.txt
        
        echo "ç”Ÿæˆçš„ cross-file.txt å†…å®¹:"
        cat cross-file.txt
        
        # ä¸º armhf åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build-armhf
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
        export CC="arm-linux-gnueabihf-gcc"
        export CXX="arm-linux-gnueabihf-g++"
        export AR="arm-linux-gnueabihf-ar"
        export STRIP="arm-linux-gnueabihf-strip"
        export PKG_CONFIG_PATH="/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/arm-linux-gnueabihf/lib/pkgconfig:/usr/share/pkgconfig"
        export PKG_CONFIG_LIBDIR="/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/arm-linux-gnueabihf/lib/pkgconfig:/usr/share/pkgconfig"
        export CFLAGS="-march=armv8-a -mfpu=neon-vfpv4 -mfloat-abi=hard -marm"
        export CXXFLAGS="-march=armv8-a -mfpu=neon-vfpv4 -mfloat-abi=hard -marm"
        export LDFLAGS="-march=armv8-a -mfpu=neon-vfpv4 -mfloat-abi=hard -marm"
        
        # æ£€æŸ¥äº¤å‰ç¼–è¯‘å·¥å…·æ˜¯å¦å¯ç”¨
        echo "æ£€æŸ¥äº¤å‰ç¼–è¯‘å·¥å…·:"
        which arm-linux-gnueabihf-gcc
        arm-linux-gnueabihf-gcc --version
        
        # æ£€æŸ¥ç›®æ ‡æ¶æ„åº“è·¯å¾„
        echo "æ£€æŸ¥ç›®æ ‡æ¶æ„åº“è·¯å¾„:"
        ls -la /usr/lib/arm-linux-gnueabihf/libz.* 2>/dev/null || echo "æœªæ‰¾åˆ° armhf çš„ libz"
        echo "ä¸»æœºæ¶æ„åº“è·¯å¾„ (åº”è¯¥é¿å…ä½¿ç”¨):"
        ls -la /usr/lib/aarch64-linux-gnu/libz.* 2>/dev/null || echo "æœªæ‰¾åˆ° aarch64 çš„ libz"
        
        echo "æ­£åœ¨é…ç½® Mesa æ„å»º (armhf)..."
        
        # å°è¯•é…ç½® - ä½¿ç”¨æ›´ç®€åŒ–çš„é…ç½®ä»¥å‡å°‘ä¾èµ–
        #CONFIG_SUCCESS=false
        
        # å°è¯•æ–¹æ¡ˆï¼šç®€åŒ–çš„é…ç½®ï¼Œç¦ç”¨æ›´å¤šå¯é€‰åŠŸèƒ½
        echo "å°è¯•ç®€åŒ–é…ç½®..."
        meson setup build-armhf \
           --cross-file cross-file.txt \
           --libdir=lib32 \
           -Dprefix=$INSTALL_PREFIX \
           -Dbuildtype=release \
            -Doptimization=3 \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=disabled \
            -Dshared-llvm=disabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dmediafoundation-codecs=all \
            -Dgbm=enabled
        
        if [ $? -eq 0 ]; then
          echo "âœ… é…ç½®æˆåŠŸ"
          CONFIG_SUCCESS=true
        else
          echo "âŒ é…ç½®å¤±è´¥ï¼Œå°è¯•è¿›ä¸€æ­¥ç®€åŒ–..."
          rm -rf build-armhf
          mkdir -p build-armhf
          
          # è¿›ä¸€æ­¥ç®€åŒ–çš„é…ç½®
          meson setup build-armhf \
           --cross-file cross-file.txt \
           --libdir=lib32 \
           -Dprefix=$INSTALL_PREFIX \
           -Dbuildtype=release \
            -Doptimization=3 \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dmediafoundation-codecs=all \
            -Dgbm=enabled
        
        
          if [ $? -eq 0 ]; then
            echo "âœ… ç®€åŒ–é…ç½®æˆåŠŸ"
            CONFIG_SUCCESS=true
          else
            echo "âŒ æ‰€æœ‰é…ç½®å°è¯•éƒ½å¤±è´¥äº†"
            exit 1
          fi
        fi
        
        if [ "$CONFIG_SUCCESS" = "true" ]; then
          echo "ğŸ—ï¸  æ­£åœ¨æ„å»º armhf..."
          # å°è¯•æ„å»ºï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€åˆ°å•çº¿ç¨‹æ„å»º
          if ninja -C build-armhf -j$(nproc); then
            echo "âœ… å¹¶è¡Œæ„å»ºæˆåŠŸ"
          else
            echo "âš ï¸ å¹¶è¡Œæ„å»ºå¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹æ„å»º..."
            if ninja -C build-armhf -j1; then
              echo "âœ… å•çº¿ç¨‹æ„å»ºæˆåŠŸ"
            else
              echo "âŒ æ„å»ºå¤±è´¥"
              exit 1
            fi
          fi
          
          echo "ğŸ“¦ æ­£åœ¨å®‰è£… armhf..."
          sudo ninja -C build-armhf install
          
          # éªŒè¯å®‰è£…
          echo "armhf å®‰è£…éªŒè¯:"
          ls -la $INSTALL_PREFIX/lib/
          echo "armhf åº“æ–‡ä»¶æ¶æ„:"
          file $INSTALL_PREFIX/lib/*.so 2>/dev/null | head -5 || true
        fi



    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
        
        # åˆ›å»ºç‰ˆæœ¬åŒ–çš„åŒ…å
        if [ "$TARGET_ARCH" = "both" ]; then
          PACKAGE_NAME="glibcmesa-${MESA_VERSION}-multiarch"
          ARCH_DESC="multiarch (aarch64 + armhf)"
        elif [ "$TARGET_ARCH" = "aarch64" ]; then
          PACKAGE_NAME="glibcmesa-${MESA_VERSION}-aarch64"
          ARCH_DESC="aarch64"
        elif [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          PACKAGE_NAME="glibcmesa-${MESA_VERSION}-armhf"
          ARCH_DESC="arm-linux-gnueabihf"
        fi
        
        # æ‰“åŒ…å®Œæ•´å®‰è£…ç›®å½•
        cd /data/data/com.termux/files/usr
        tar -czvf "${HOME}/${PACKAGE_NAME}-full.tar.gz" glibc/
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        cd $GITHUB_WORKSPACE
        mv "${HOME}/${PACKAGE_NAME}-full.tar.gz" .
        sha256sum ${PACKAGE_NAME}-*.tar.gz > checksums.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        echo "ARCH_DESC=${ARCH_DESC}" >> $GITHUB_ENV
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: glibcmesa-${{ env.MESA_VERSION }}-${{ env.TARGET_ARCH }}
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: åˆ›å»ºè½»é‡çº§å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: glibcmesa-${{ env.MESA_VERSION }}-${{ env.TARGET_ARCH }}-${{ env.BUILD_DATE }}
        name: Mesa glibc ${{ env.MESA_VERSION }} (${{ env.ARCH_DESC }})
        body: |
          Mesa 3D Graphics Library for Termux glibc (glibc)
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.MESA_VERSION }}
          - **æ¶æ„**: ${{ env.ARCH_DESC }}
          - **Git æè¿°**: ${{ env.GIT_DESCRIBE }}
          - **æäº¤å“ˆå¸Œ**: ${{ env.MESA_GIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **åˆ†æ”¯**: ${{ env.MESA_BRANCH }}
          - **ä»“åº“**: $(if [ "${{ env.USE_UPSTREAM }}" = "true" ]; then echo "ä¸Šæ¸¸å®˜æ–¹"; else echo "lfdevs/android-container"; fi)
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.FULL_PACKAGE }}` - å®Œæ•´ Mesa å®‰è£…åŒ…
          - `checksums.txt` - æ ¡éªŒå’Œæ–‡ä»¶
          
          $(if [ "${{ env.TARGET_ARCH }}" = "both" ]; then
            echo "å¤šæ¶æ„åŒ…ç›®å½•ç»“æ„:"
            echo "```"
            echo "mesa/"
            echo "â”œâ”€â”€ bin/                 # å¯æ‰§è¡Œæ–‡ä»¶"
            echo "â”œâ”€â”€ include/             # å¤´æ–‡ä»¶"
            echo "â”œâ”€â”€ lib/                 # åº“ç›®å½•"
            echo "â”‚   â”œâ”€â”€ aarch64-linux-gnu -> ../lib64/   # 64ä½åº“ç¬¦å·é“¾æ¥"
            echo "â”‚   â””â”€â”€ arm-linux-gnueabihf -> ../lib32/ # 32ä½åº“ç¬¦å·é“¾æ¥"
            echo "â”œâ”€â”€ lib64/               # 64ä½ (aarch64) åº“"
            echo "â”‚   â””â”€â”€ dri/             # 64ä½ DRI é©±åŠ¨ (å¦‚æœå¯ç”¨)"
            echo "â””â”€â”€ lib32/               # 32ä½ (armhf) åº“"
            echo "    â””â”€â”€ dri/             # 32ä½ DRI é©±åŠ¨ (å¦‚æœå¯ç”¨)"
            echo "```"
          fi)
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´çš„ tar.gz åŒ…
          2. åœ¨ glibc ç¯å¢ƒä¸­è§£å‹åˆ°æ ¹ç›®å½•: `tar -xzf package.tar.gz -C /`
          
          $(if [ "${{ env.TARGET_ARCH }}" = "both" ]; then
            echo "å¤šæ¶æ„ä½¿ç”¨è¯´æ˜:"
            echo "- é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ¶æ„"
            echo "- å¯ä»¥æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡æ¥é€‰æ‹©ç‰¹å®šæ¶æ„:"
            echo "  ```bash"
            echo "  # ä½¿ç”¨ 64 ä½åº“"
            echo "  export LD_LIBRARY_PATH=/data/data/com.termux/files/usr/glibc/lib64:/data/data/com.termux/files/usr/glibc/lib64/dri:\$LD_LIBRARY_PATH"
            echo "  export LIBGL_DRIVERS_PATH=/data/data/com.termux/files/usr/glibc/lib64/dri"
            echo "  # æˆ–è€…ä½¿ç”¨ 32 ä½åº“"
            echo "  export LD_LIBRARY_PATH=/data/data/com.termux/files/usr/glibc/lib32:/data/data/com.termux/files/usr/glibc/lib32/dri:\$LD_LIBRARY_PATH"
            echo "  export LIBGL_DRIVERS_PATH=/data/data/com.termux/files/usr/glibc/lib32/dri"
            echo "  ```"
          else
            echo "ä½¿ç”¨è¯´æ˜:"
            echo "  ```bash"
            echo "  export LD_LIBRARY_PATH=/data/data/com.termux/files/usr/glibc/lib:/data/data/com.termux/files/usr/glibc/lib/dri:\$LD_LIBRARY_PATH"
            echo "  export LIBGL_DRIVERS_PATH=/data/data/com.termux/files/usr/glibc/lib/dri"
            echo "  ```"
          fi)
          
          é©±åŠ¨æ”¯æŒ:
          $(if [ "${{ env.TARGET_ARCH }}" = "aarch64" ] || [ "${{ env.TARGET_ARCH }}" = "both" ]; then
            echo "- **aarch64**:"
            echo "  - âœ“ Gallium: freedreno, zink"
            echo "  - âœ“ Vulkan: freedreno"
            echo "  - âœ“ OpenGL, OpenGL ES 1.x/2.x"
            echo "  - âœ“ EGL, GBM"
          fi)
          
          $(if [ "${{ env.TARGET_ARCH }}" = "arm-linux-gnueabihf" ] || [ "${{ env.TARGET_ARCH }}" = "both" ]; then
            echo "- **armhf**:"
            echo "  - âœ“ Gallium: swrast (è½¯ä»¶æ¸²æŸ“)"
            echo "  - âœ“ OpenGL, OpenGL ES 1.x/2.x"
            echo "  - âœ“ EGL"
            echo "  - âœ— Vulkan (å·²ç¦ç”¨)"
          fi)
          
          æ³¨æ„:
          - éœ€è¦ Termux çš„ glibc ç¯å¢ƒ (å¦‚ glibcdistro çš„ Ubuntu/Debian)
          - æ¨èåœ¨ glibc å®¹å™¨ä¸­ä½¿ç”¨
          - å·²ç¦ç”¨ Wayland æ”¯æŒ
          - armhf ç‰ˆæœ¬ä¸ºè½¯ä»¶æ¸²æŸ“ï¼Œé€‚ç”¨äºå…¼å®¹æ€§éœ€æ±‚
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“
      run: |
        echo "âœ… Mesa glibc æ„å»ºå®Œæˆ!"
        echo "================================"
        echo "ç‰ˆæœ¬: $MESA_VERSION"
        echo "æäº¤: $MESA_GIT_HASH"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "åˆ†æ”¯: $MESA_BRANCH"
        echo "ç›®æ ‡æ¶æ„: $ARCH_DESC"
        echo "ç¯å¢ƒ: Termux (glibc)"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        
        # æ˜¾ç¤ºæ¶æ„ç‰¹å®šçš„ä¿¡æ¯
        if [ "$TARGET_ARCH" = "aarch64" ] || [ "$TARGET_ARCH" = "both" ]; then
          echo "aarch64 æ¶æ„æ”¯æŒ:"
          echo "  âœ“ Gallium: freedreno, zink"
          echo "  âœ“ Vulkan: freedreno"
          echo "  âœ“ OpenGL, OpenGL ES 1.x/2.x"
          echo "  âœ“ EGL, GBM"
          echo ""
        fi
        
        if [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ] || [ "$TARGET_ARCH" = "both" ]; then
          echo "armhf æ¶æ„æ”¯æŒ:"
          echo "  âœ“ Gallium: swrast (è½¯ä»¶æ¸²æŸ“)"
          echo "  âœ“ OpenGL, OpenGL ES 1.x/2.x"
          echo "  âœ“ EGL"
          echo "  âœ— Vulkan (å·²ç¦ç”¨)"
          echo "  âœ— Wayland (å·²ç¦ç”¨)"
          echo ""
        fi
        
        if [ "$TARGET_ARCH" = "both" ]; then
          echo "å¤šæ¶æ„ç›®å½•ç»“æ„:"
          echo "  /data/data/com.termux/files/usr/glibc/lib64/    - 64ä½ (aarch64) åº“"
          echo "  /data/data/com.termux/files/usr/glibc/lib32/    - 32ä½ (armhf) åº“"
          echo "  /data/data/com.termux/files/usr/glibc/lib/      - ç¬¦å·é“¾æ¥åˆ°å¯¹åº”æ¶æ„"
        fi
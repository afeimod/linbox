name: Wine and Proton 无bootBuilder

on:
  schedule:
    # Proton 构建 - 每月1号和15号
    - cron: '0 0 1,15 * *'
    # Wine 构建 - 每月5号和20号
    - cron: '0 2 5,20 * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        required: true
        default: 'proton'
        type: choice
        options:
        - proton
        - wine-wow64
      proton_branch:
        description: 'Proton 分支 (仅 Proton 构建)'
        required: false
        default: 'proton_10.0'
        type: choice
        options:
        - proton_10.0
        - experimental_10.0
        - bleeding-edge
      wine_branch:
        description: 'Wine 分支 (仅 Wine 构建)'
        required: false
        default: 'staging'
        type: choice
        options:
        - vanilla
        - staging
        - staging-tkg
        - staging-tkg-fsync
      wine_version:
        description: 'Wine 版本 (仅 Wine 构建)'
        required: false
        default: 'latest'
        type: string

env:
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_wine

jobs:
  build-proton:
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_type == 'proton' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1,15 * *')
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安装构建依赖
        run: |
          sudo apt update
          # 先修复损坏的依赖
          sudo apt --fix-broken install -y
          
          # 基础构建依赖
          BASE_DEPS="\
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc-multilib \
            g++-multilib \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            mingw-w64 \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans"
          
          sudo apt install -y $BASE_DEPS

      - name: 安装多媒体和音频依赖
        run: |
          sudo apt update
          # 安装多媒体相关包
          sudo apt install -y \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libmpg123-dev \
            libopenal-dev

      - name: 设置中文语言环境
        run: |
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 构建 Proton WOW64 版本
        run: |
          set -e
          
          echo "开始构建 Proton WOW64 版本..."
          echo "分支: ${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
          
          # 设置中文构建环境
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          # 清理并创建构建目录
          rm -rf $BUILD_DIR/proton
          mkdir -p $BUILD_DIR/proton
          cd $BUILD_DIR/proton
          
          # 克隆 Proton 源码
          git clone https://github.com/ValveSoftware/wine
          cd wine
          
          # 切换到指定的 Proton 分支
          PROTON_BRANCH="${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
          echo "切换到分支: $PROTON_BRANCH"
          git checkout $PROTON_BRANCH
          
          # 修复 Termux 路径问题
          echo "修复 Termux 路径问题..."
          find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
          find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "file.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "loader.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "server.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          
          echo "路径修复完成"
          
          # 生成 configure 脚本
          echo "生成 configure 脚本..."
          ./autogen.sh
          
          # 配置和构建真正的 WOW64 Proton
          mkdir -p build-wow64
          cd build-wow64
          
          export CROSSCC="x86_64-w64-mingw32-gcc"
          export CROSSCXX="x86_64-w64-mingw32-g++"
          export CFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"

          # 配置真正的 WOW64 Proton，启用 Vulkan 和完整 GStreamer 支持
          ../configure \
            --enable-win64 \
            --enable-archs=i386,x86_64 \
            --prefix=/tmp/wine-install-proton \
            --with-x \
            --with-vulkan \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland

          # 构建真正的 WOW64 Proton
          echo "开始构建支持 Vulkan 和完整 GStreamer 的 WOW64 Proton..."
          make -j$(nproc)
          make install
          
          cd ../..
          
          # 获取版本信息
          VERSION_PROTON=$(cd wine && git describe --tags --abbrev=0 2>/dev/null || echo "$PROTON_BRANCH")
          COMMIT_HASH=$(cd wine && git rev-parse --short HEAD)
          PROTON_VERSION="${VERSION_PROTON}-${COMMIT_HASH}"
          echo "PROTON_VERSION=$PROTON_VERSION" >> $GITHUB_ENV
          echo "BUILD_NAME=proton-${PROTON_VERSION}-wow64" >> $GITHUB_ENV

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 复制 Wine 安装文件
          echo "复制 Wine 文件到 $PACKAGE_NAME..."
          cp -r /tmp/wine-install-proton/* wine-package/$PACKAGE_NAME/

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "最终文件结构:"
          find wine-package -type f | sort | head -20
          
          # 使用 tar.xz 格式打包
          tar -cJf $PACKAGE_NAME.tar.xz -C wine-package $PACKAGE_NAME
          
          echo "打包完成:"
          ls -lh *.tar.xz

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Proton artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-WoW64
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

  build-wine-wow64:
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_type == 'wine-wow64' || (github.event_name == 'schedule' && github.event.schedule == '0 2 5,20 * *')
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安装构建依赖
        run: |
          sudo apt update
          # 先修复损坏的依赖
          sudo apt --fix-broken install -y
          
          # 基础构建依赖
          BASE_DEPS="\
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc-multilib \
            g++-multilib \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            mingw-w64 \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans"
          
          sudo apt install -y $BASE_DEPS

      - name: 安装多媒体和音频依赖
        run: |
          sudo apt update
          # 安装多媒体相关包
          sudo apt install -y \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libmpg123-dev \
            libopenal-dev

      - name: 设置中文语言环境
        run: |
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 构建 Wine WOW64 版本
        run: |
            set -e
            
            # 设置环境变量
            export WINE_BRANCH="${{ github.event.inputs.wine_branch || 'staging' }}"
            export WINE_VERSION="${{ github.event.inputs.wine_version || 'latest' }}"
            export BUILD_DIR="/tmp/build_wine_${WINE_BRANCH}_${WINE_VERSION}"
            
            echo "开始构建 Wine WOW64 版本..."
            echo "分支: $WINE_BRANCH"
            echo "版本: $WINE_VERSION"
            
            # 设置中文构建环境
            export LANG=zh_CN.UTF-8
            export LC_ALL=zh_CN.UTF-8
            export LANGUAGE=zh_CN:zh:en_US:en
            
            # 清理并创建构建目录
            rm -rf "$BUILD_DIR"
            mkdir -p "$BUILD_DIR"
            cd "$BUILD_DIR"
            
            # 根据分支获取 Wine 源码
            if [ "$WINE_BRANCH" = "staging-tkg" ] || [ "$WINE_BRANCH" = "staging-tkg-fsync" ]; then
              if [ "$WINE_BRANCH" = "staging-tkg" ]; then
                        git clone --depth=1 https://github.com/Kron4ek/wine-tkg wine
              else
                        git clone --depth=1 https://github.com/Kron4ek/wine-tkg wine -b fsync
              fi
              WINE_VERSION_ACTUAL="$(cat wine/VERSION | tail -c +14)"
              BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${WINE_BRANCH}-wow64"
            elif [ "$WINE_BRANCH" = "staging" ]; then
              git clone https://github.com/wine-mirror/wine.git wine
              cd wine
              
              # 关闭 detached HEAD 建议
              git config advice.detachedHead false
              
              if [ "$WINE_VERSION" != "latest" ]; then
                        git checkout wine-$WINE_VERSION
              fi
              WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
              COMMIT_HASH=$(git rev-parse --short HEAD)
              BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-staging-wow64"
              
              # 修复：从 wine-X.Y 格式中提取纯版本号
              PURE_VERSION=$(echo "$WINE_VERSION_ACTUAL" | sed 's/^wine-//')
              echo "提取的纯版本号: $PURE_VERSION"
              
              # 使用正确的版本格式：vX.Y 而不是 wine-X.Y
              STAGING_VERSION="v${PURE_VERSION}"
              echo "尝试下载 staging 补丁版本: $STAGING_VERSION"
              
              # 下载并应用 staging 补丁 - 修复版本格式
              wget -O wine-staging-${PURE_VERSION}.tar.gz https://github.com/wine-staging/wine-staging/archive/refs/tags/${STAGING_VERSION}.tar.gz || \
              wget -O wine-staging-${PURE_VERSION}.tar.gz https://github.com/wine-staging/wine-staging/archive/refs/tags/v${PURE_VERSION}.tar.gz
              
              if [ -f "wine-staging-${PURE_VERSION}.tar.gz" ]; then
                        tar -xzf wine-staging-${PURE_VERSION}.tar.gz
                        
                        # 应用 staging 补丁 - 修复目录名检查逻辑
                        echo "查找解压后的 staging 目录..."
                        ls -la
                        
                        # 根据 build-wine-test.yml 的正确逻辑
                        if [ -d "wine-staging-${PURE_VERSION}" ]; then
                          echo "找到目录: wine-staging-${PURE_VERSION}"
                          cd wine-staging-${PURE_VERSION}/staging
                          chmod +x patchinstall.py
                          ./patchinstall.py --all --destdir=../../
                          cd ../..
                        elif [ -d "wine-staging-v${PURE_VERSION}" ]; then
                          echo "找到目录: wine-staging-v${PURE_VERSION}"
                          cd wine-staging-v${PURE_VERSION}/staging
                          chmod +x patchinstall.py
                          ./patchinstall.py --all --destdir=../../
                          cd ../..
                        elif [ -d "wine-staging-${STAGING_VERSION}" ]; then
                          echo "找到目录: wine-staging-${STAGING_VERSION}"
                          cd wine-staging-${STAGING_VERSION}/staging
                          chmod +x patchinstall.py
                          ./patchinstall.py --all --destdir=../../
                          cd ../..
                        else
                          echo "警告: 未找到预期的 staging 目录结构，尝试自动查找..."
                          # 尝试查找任何包含 staging 的目录
                          STAGING_DIR=$(find . -maxdepth 1 -type d -name "*staging*" | head -1)
                          if [ -n "$STAGING_DIR" ] && [ -d "$STAGING_DIR/staging" ]; then
                                    echo "找到 staging 目录: $STAGING_DIR"
                                    cd $STAGING_DIR/staging
                                    chmod +x patchinstall.py
                                    ./patchinstall.py --all --destdir=../../
                                    cd ../..
                          else
                                    echo "❌ 错误：无法找到 staging 补丁目录，跳过补丁应用"
                                    echo "当前目录内容:"
                                    ls -la
                          fi
                        fi
              else
                        echo "警告: 无法下载 staging 补丁，继续构建无补丁版本"
              fi
              
              cd ..
              
            elif [ "$WINE_BRANCH" = "vanilla" ]; then
              git clone https://github.com/wine-mirror/wine.git wine
              cd wine
              
              # 关闭 detached HEAD 建议
              git config advice.detachedHead false
              
              if [ "$WINE_VERSION" != "latest" ]; then
                        git checkout wine-$WINE_VERSION
              fi
              WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
              COMMIT_HASH=$(git rev-parse --short HEAD)
              BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-vanilla-wow64"
              cd ..
            else
              echo "未知的 Wine 分支: $WINE_BRANCH"
              exit 1
            fi
            
            echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
            
            cd wine
            
            # 修复 Termux 路径问题
            echo "修复 Termux 路径问题..."
            find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
            find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
            find . -name "file.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
            find . -name "loader.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
            find . -name "server.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
            
            echo "路径修复完成"
            
            # 根据版本选择修复方式
            # 从 WINE_VERSION_ACTUAL 中提取纯数字版本号
            PURE_VERSION=$(echo "$WINE_VERSION_ACTUAL" | sed 's/^wine-//')
            VERSION_MAJOR=$(echo $PURE_VERSION | cut -d. -f1)
            VERSION_MINOR=$(echo $PURE_VERSION | cut -d. -f2)
            
            echo "Wine 版本: $WINE_VERSION_ACTUAL"
            echo "纯版本号: $PURE_VERSION"
            echo "主版本: $VERSION_MAJOR, 次版本: $VERSION_MINOR"
            
            # 判断版本是否 >= 9.10
            if [ $VERSION_MAJOR -gt 9 ] || [ $VERSION_MAJOR -eq 9 -a $VERSION_MINOR -ge 10 ]; then
                        echo "使用 9.10+ 版本的修复方式 (wine_do_not_create_dxgi_manager2.patch)"
                        wget https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
                        if [ -f "dlls/mfplat/main.c" ]; then
                                    echo "找到目标文件 dlls/mfplat/main.c，准备应用补丁..."
                                    if patch -p1 < wine_do_not_create_dxgi_manager2.patch; then
                                                echo "✅ 补丁应用成功"
                                    else
                                                echo "❌ 补丁应用失败"
                                                exit 1
                                    fi
                        else
                                    echo "❌ 错误：目标文件 dlls/mfplat/main.c 不存在"
                                    exit 1
                        fi
            else
                        echo "使用 9.10 以下版本的修复方式 (fix_wine9.2_mfplat.sh)"
                        wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
                        chmod +x fix_wine9.2_mfplat.sh
                        ./fix_wine9.2_mfplat.sh
                        echo "✅ 9.10 以下版本修复完成"
            fi
            
            
            # 配置和构建真正的 WOW64 Wine
            mkdir -p build-wow64
            cd build-wow64
            
            export CROSSCC="x86_64-w64-mingw32-gcc"
            export CROSSCXX="x86_64-w64-mingw32-g++"
            export CFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
            export CXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
            export CROSSCFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
            export CROSSCXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"

            # 配置真正的 WOW64 Wine，启用 Vulkan 和完整 GStreamer 支持
            ../configure \
              --enable-win64 \
              --enable-archs=i386,x86_64 \
              --prefix=/tmp/wine-install-wow64 \
              --with-x \
              --with-vulkan \
              --with-alsa \
              --with-pulse \
              --with-freetype \
              --with-fontconfig \
              --with-gstreamer \
              --with-gettext \
              --with-sdl \
              --enable-nls \
              --disable-winemenubuilder \
              --disable-win16 \
              --disable-tests \
              --without-ldap \
              --without-capi \
              --without-oss \
              --without-cups \
              --without-dbus \
              --without-coreaudio \
              --without-gphoto \
              --without-osmesa \
              --without-sane \
              --without-pcap \
              --without-pcsclite \
              --without-udev \
              --without-unwind \
              --without-usb \
              --without-v4l2 \
              --without-wayland

            # 构建真正的 WOW64 Wine
            echo "开始构建支持 Vulkan 和完整 GStreamer 的 WOW64 Wine..."
            make -j$(nproc)
            make install

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 复制 Wine 安装文件
          echo "复制 Wine 文件到 $PACKAGE_NAME..."
          cp -r /tmp/wine-install-wow64/* wine-package/$PACKAGE_NAME/

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "最终文件结构:"
          find wine-package -type f | sort | head -20
          
          # 使用 tar.xz 格式打包
          tar -cJf $PACKAGE_NAME.tar.xz -C wine-package $PACKAGE_NAME
          
          echo "打包完成:"
          ls -lh *.tar.xz

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Wine WoW64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-WoW64
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30
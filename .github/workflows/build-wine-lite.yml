# build-wine-lite.yml
name: Build AllWine Esync WOW64 for Termux

on:
  workflow_dispatch:
    inputs:
      wine_version:
        description: 'Wine ç‰ˆæœ¬ (åˆ†æ”¯ã€æ ‡ç­¾æˆ–æäº¤å“ˆå¸Œ)'
        required: true
        default: 'wine-9.2'
        type: string
      wine_staging_version:
        description: 'Wine Staging ç‰ˆæœ¬ (å¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨åŒ¹é…)'
        required: false
        type: string

permissions:
  contents: write

env:
  VERSION_PREFIX: "full"

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: è®¾ç½® Wine ç‰ˆæœ¬
      id: set_version
      run: |
        # è®¾ç½® Wine ç‰ˆæœ¬
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "WINE_VERSION=${{ github.event.inputs.wine_version }}" >> $GITHUB_ENV
          echo "WINE_STAGING_VERSION=${{ github.event.inputs.wine_staging_version }}" >> $GITHUB_ENV
        else
          # é»˜è®¤ç‰ˆæœ¬
          echo "WINE_VERSION=wine-9.2" >> $GITHUB_ENV
          echo "WINE_STAGING_VERSION=" >> $GITHUB_ENV
        fi
        
        # å¦‚æœæ²¡æœ‰æŒ‡å®š staging ç‰ˆæœ¬ï¼Œåˆ™è‡ªåŠ¨åŒ¹é…
        if [ -z "$WINE_STAGING_VERSION" ]; then
          # ä» Wine ç‰ˆæœ¬ä¸­æå–æ•°å­—éƒ¨åˆ†
          if [[ "$WINE_VERSION" =~ wine-([0-9]+\.[0-9]+) ]]; then
            WINE_STAGING_VERSION="v${BASH_REMATCH[1]}"
          else
            WINE_STAGING_VERSION="master"
          fi
          echo "WINE_STAGING_VERSION=$WINE_STAGING_VERSION" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®æ„å»ºç‰ˆæœ¬åç§°
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "FULL_VERSION=${WINE_VERSION#wine-}-${VERSION_PREFIX}" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨çš„ Wine ç‰ˆæœ¬: $WINE_VERSION"
        echo "ä½¿ç”¨çš„ Staging ç‰ˆæœ¬: $WINE_STAGING_VERSION"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "å®Œæ•´ç‰ˆæœ¬: $FULL_VERSION"

    - name: å®‰è£…æ„å»ºä¾èµ–
      run: |
        sudo apt update
        sudo apt --fix-broken install -y
        sudo apt install -y \
          debootstrap \
          perl \
          git \
          wget \
          xz-utils \
          bubblewrap \
          autoconf \
          flex \
          bison \
          gcc-multilib \
          g++-multilib \
          libx11-dev \
          libxext-dev \
          libxi-dev \
          libxrandr-dev \
          libxcursor-dev \
          libxcomposite-dev \
          libxdamage-dev \
          libxfixes-dev \
          libxxf86vm-dev \
          libxrender-dev \
          libxinerama-dev \
          libgl-dev \
          libglu-dev \
          libosmesa6-dev \
          libfreetype6-dev \
          libfontconfig1-dev \
          libpcap-dev \
          libdbus-1-dev \
          libssl-dev \
          libasound2-dev \
          libpulse-dev \
          libudev-dev \
          libcups2-dev \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          libxml2-dev \
          libvulkan-dev \
          vulkan-tools \
          libvulkan1 \
          mesa-vulkan-drivers \
          mingw-w64 \
          gettext \
          libgettextpo-dev \
          locales \
          language-pack-zh-hans

    - name: è®¾ç½®ä¸­æ–‡è¯­è¨€ç¯å¢ƒ
      run: |
        sudo locale-gen zh_CN.UTF-8
        sudo update-locale LANG=zh_CN.UTF-8
        export LANG=zh_CN.UTF-8
        export LC_ALL=zh_CN.UTF-8

    - name: å®‰è£…å¤šåª’ä½“å’ŒéŸ³é¢‘ä¾èµ–
      run: |
        sudo apt install -y libunwind-dev
        sudo apt install -y \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libmpg123-dev \
          libopenal-dev

    - name: å…‹éš†æŒ‡å®šç‰ˆæœ¬çš„ Wine æºç 
      run: |
        git clone https://gitlab.winehq.org/wine/wine.git
        cd wine
        echo "æ­£åœ¨æ£€å‡º Wine ç‰ˆæœ¬: $WINE_VERSION"
        git checkout $WINE_VERSION
        
        # è·å–è¯¦ç»†çš„ç‰ˆæœ¬ä¿¡æ¯
        WINE_COMMIT_HASH=$(git rev-parse --short HEAD)
        WINE_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$WINE_COMMIT_HASH")
        echo "WINE_COMMIT_HASH=$WINE_COMMIT_HASH" >> $GITHUB_ENV
        echo "WINE_DESCRIBE=$WINE_DESCRIBE" >> $GITHUB_ENV
        echo "Wine æäº¤å“ˆå¸Œ: $WINE_COMMIT_HASH"
        echo "Wine æè¿°: $WINE_DESCRIBE"

    - name: ä¸‹è½½å¹¶åº”ç”¨æŒ‡å®šç‰ˆæœ¬çš„ staging è¡¥ä¸
      run: |
        cd wine
        echo "ä¸‹è½½ Wine Staging ç‰ˆæœ¬: $WINE_STAGING_VERSION"
        
        # å°è¯•ä» release æ ‡ç­¾ä¸‹è½½
        if wget -O wine-staging.tar.gz "https://github.com/wine-staging/wine-staging/archive/refs/tags/$WINE_STAGING_VERSION.tar.gz"; then
          echo "âœ… ä»æ ‡ç­¾ä¸‹è½½ Staging æˆåŠŸ"
        elif wget -O wine-staging.tar.gz "https://github.com/wine-staging/wine-staging/archive/refs/heads/$WINE_STAGING_VERSION.tar.gz"; then
          echo "âœ… ä»åˆ†æ”¯ä¸‹è½½ Staging æˆåŠŸ"
        else
          # å¦‚æœæŒ‡å®šç‰ˆæœ¬ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä¸»åˆ†æ”¯
          echo "âš ï¸ æŒ‡å®šç‰ˆæœ¬ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä¸»åˆ†æ”¯"
          wget -O wine-staging.tar.gz "https://github.com/wine-staging/wine-staging/archive/refs/heads/master.tar.gz"
          echo "WINE_STAGING_VERSION=master" >> $GITHUB_ENV
        fi
        
        tar -xzf wine-staging.tar.gz
        cd wine-staging-*/staging
        chmod +x patchinstall.py
        ./patchinstall.py --all --destdir=../../ || echo "âš ï¸ éƒ¨åˆ†è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­æ„å»º..."

    - name: åº”ç”¨å¿…è¦ä¿®å¤è¡¥ä¸
      run: |
        cd wine
        # æå– Wine ç‰ˆæœ¬å·
        WINE_BASE_VERSION=${WINE_VERSION#wine-}
        echo "Wine åŸºç¡€ç‰ˆæœ¬: $WINE_BASE_VERSION"
    
        # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸ºå¯æ¯”è¾ƒçš„æ•°å­—æ ¼å¼ï¼ˆå¦‚ 9.2 -> 902, 9.10 -> 910ï¼‰
        if [[ "$WINE_BASE_VERSION" =~ ^([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            VERSION_NUM=$((MAJOR * 100 + MINOR))
            echo "ç‰ˆæœ¬æ•°å­—: $VERSION_NUM"
        else
            # å¦‚æœä¸æ˜¯æ ‡å‡†ç‰ˆæœ¬å·æ ¼å¼ï¼ˆå¦‚mainã€masterç­‰ï¼‰ï¼Œè§†ä¸ºæœ€æ–°ç‰ˆæœ¬
            echo "éæ ‡å‡†ç‰ˆæœ¬å·ï¼Œè§†ä¸ºæœ€æ–°ç‰ˆæœ¬"
            VERSION_NUM=9999
        fi
    
        # mfplat ä¿®å¤ - æ ¹æ®ç‰ˆæœ¬é€‰æ‹©ä¸åŒçš„ä¿®å¤æ–¹å¼
        if [ $VERSION_NUM -ge 900 ] && [ $VERSION_NUM -le 905 ]; then
            # Wine 9.0 - 9.5 ä½¿ç”¨ fix_wine9.2_mfplat.sh
            echo "ğŸ”§ æ£€æµ‹åˆ° Wine 9.0-9.5 ç‰ˆæœ¬ï¼Œä½¿ç”¨ 9.2 mfplat ä¿®å¤"
            if wget -O fix_wine_mfplat.sh "https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh"; then
              chmod +x fix_wine_mfplat.sh
              ./fix_wine_mfplat.sh
              echo "âœ… Wine $WINE_BASE_VERSION mfplat ä¿®å¤åº”ç”¨æˆåŠŸ"
            else
              echo "âš ï¸ Wine 9.2 mfplat ä¿®å¤è„šæœ¬ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"
            fi
        elif [ $VERSION_NUM -ge 906 ] || [ "$WINE_VERSION" = "main" ] || [ "$WINE_VERSION" = "master" ]; then
            # Wine 9.6+ æˆ– main/master åˆ†æ”¯ä½¿ç”¨ patch æ–¹å¼
            echo "ğŸ”§ æ£€æµ‹åˆ° Wine 9.6+ æˆ–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ dxgi manager2 è¡¥ä¸"
            if wget -O wine_do_not_create_dxgi_manager2.patch "https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch"; then
              if patch -p1 -N < wine_do_not_create_dxgi_manager2.patch; then
                echo "âœ… dxgi manager2 è¡¥ä¸åº”ç”¨æˆåŠŸ"
              else
                echo "âš ï¸ dxgi manager2 è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œè·³è¿‡"
              fi
            else
              echo "âš ï¸ dxgi manager2 è¡¥ä¸ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"
            fi
        else
            echo "â„¹ï¸  Wine ç‰ˆæœ¬ $WINE_BASE_VERSION ä¸åœ¨ç‰¹å®šä¿®å¤èŒƒå›´å†…ï¼Œè·³è¿‡ mfplat ä¿®å¤"
        fi
    
        # è¿”å›å€¼ä¿®å¤ - é€šç”¨è¡¥ä¸ï¼ˆä¿æŒåŸæ ·ï¼‰
        if wget -O fix_return_value.patch "https://github.com/afeimod/linbox/raw/main/path/fix_return_value.patch"; then
          if patch -p1 -N < fix_return_value.patch; then
            echo "âœ… è¿”å›å€¼ä¿®å¤è¡¥ä¸åº”ç”¨æˆåŠŸ"
          else
            echo "âš ï¸ è¿”å›å€¼ä¿®å¤è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œè·³è¿‡"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°è¿”å›å€¼ä¿®å¤è¡¥ä¸ï¼Œè·³è¿‡"
        fi

    - name: ä¿®å¤ Termux è·¯å¾„é—®é¢˜
      run: |
        cd wine
        find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
        find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +

    - name: é…ç½®å’Œæ„å»º WOW64 Wine
      run: |
        cd wine
        mkdir -p /tmp/wine-install
        sudo chmod 777 -R /tmp/wine-install

        mkdir -p build-wow64
        cd build-wow64
        ../configure \
          --enable-win64 \
          --enable-archs=i386,x86_64 \
          --prefix=/tmp/wine-install \
          --with-x \
          --with-vulkan \
          --with-cups \
          --with-freetype \
          --with-fontconfig \
          --with-gstreamer \
          --with-gettext \
          --enable-nls \
          --disable-winemenubuilder \
          --disable-win16 \
          --disable-tests \
          --disable-debug \
          --disable-winemsibuilder \
          --without-xinerama \
          --without-capi \
          --without-oss \
          --without-cups \
          --without-coreaudio \
          --without-gphoto \
          --without-osmesa \
          --without-sane \
          --without-piper \
          --without-pcap \
          --without-pcsclite \
          --without-udev \
          --without-unwind \
          --without-usb \
          --without-v4l2 \
          --without-wayland

        # æ­£å¸¸ç¼–è¯‘ï¼Œä¸è¿›è¡Œä¼˜åŒ–ç²¾ç®€
        make -j$(nproc)
        make install

    - name: å‡†å¤‡å®Œæ•´æ‰“åŒ…
      run: |
        mkdir -p wine-package/opt/wine
        mkdir -p wine-package/share/fonts
        
        echo "å¤åˆ¶å®Œæ•´çš„ Wine æ–‡ä»¶..."
        cp -r /tmp/wine-install/* wine-package/opt/wine/
        
        echo "ä¸‹è½½å¿…éœ€å­—ä½“..."
        cd wine-package/share/fonts
        wget -q https://github.com/adobe-fonts/source-han-sans/raw/release/OTF/SourceHanSansSC-Regular.otf || echo "å­—ä½“ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­..."
        cd ../../..

        echo "å®Œæ•´æ„å»ºå¤§å°:"
        du -sh wine-package/

    - name: åˆ›å»ºæ‰“åŒ…æ–‡ä»¶
      run: |
        tar -czf wine-${{ env.FULL_VERSION }}-${{ env.BUILD_DATE }}-wow64-esync-termux.tar.gz wine-package/
        echo "æ‰“åŒ…å®Œæˆ:"
        ls -lh wine-*.tar.gz

    - name: æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        echo "æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶:"
        ls -la wine-*.tar.gz
        if [ ! -f "wine-${{ env.FULL_VERSION }}-${{ env.BUILD_DATE }}-wow64-esync-termux.tar.gz" ]; then
          echo "é”™è¯¯ï¼šæ‰“åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          exit 1
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: wine-${{ env.WINE_VERSION }}-${{ env.BUILD_DATE }}-wow64-esync-termux
        path: wine-${{ env.WINE_VERSION }}-${{ env.BUILD_DATE }}-wow64-esync-termux.tar.gz

    - name: åˆ›å»ºå‘å¸ƒæ ‡ç­¾
      id: create_tag
      run: |
        RELEASE_TAG="wine-${{ env.WINE_VERSION }}-${{ env.FULL_VERSION }}-${{ env.BUILD_DATE }}"
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "Release æ ‡ç­¾: $RELEASE_TAG"

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: Wine ${{ env.WINE_VERSION }} ${{ env.FULL_VERSION }} (WOW64 with Esync for Termux)
        body: |
          Full Wine WOW64 with Esync for Termux
          
          æ„å»ºä¿¡æ¯:
          - **Wine ç‰ˆæœ¬**: ${{ env.WINE_VERSION }}
          - **Wine æè¿°**: ${{ env.WINE_DESCRIBE }}
          - **æäº¤å“ˆå¸Œ**: ${{ env.WINE_COMMIT_HASH }}
          - **Staging ç‰ˆæœ¬**: ${{ env.WINE_STAGING_VERSION }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **å®Œæ•´ç‰ˆæœ¬**: ${{ env.FULL_VERSION }}
          
          æ¶æ„: x86_64 WOW64
          ç¯å¢ƒ: Termux
          
          ä¿®å¤å†…å®¹:
          - âœ… Wine ${{ env.WINE_VERSION }} mfplat ä¿®å¤
          - âœ… è¿”å›å€¼ä¿®å¤
          - âœ… Esync ä¿®å¤
          - âœ… Termux è·¯å¾„ä¿®å¤
          
          å®‰è£…è¯´æ˜:
          1. è§£å‹åˆ° Termux çš„æ ¹ç›®å½•
          2. æ·»åŠ  `/opt/wine/bin` åˆ° PATH ç¯å¢ƒå˜é‡
        files: wine-${{ env.FULL_VERSION }}-${{ env.BUILD_DATE }}-wow64-esync-termux.tar.gz
        draft: false
        prerelease: false

    - name: è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "âœ… Wine WOW64 with Esync æ„å»ºå®Œæˆ"
        echo "Wine ç‰ˆæœ¬: ${{ env.WINE_VERSION }}"
        echo "Wine æè¿°: ${{ env.WINE_DESCRIBE }}"
        echo "æäº¤å“ˆå¸Œ: ${{ env.WINE_COMMIT_HASH }}"
        echo "Staging ç‰ˆæœ¬: ${{ env.WINE_STAGING_VERSION }}"
        echo "å®Œæ•´ç‰ˆæœ¬: ${{ env.FULL_VERSION }}"
        echo "æ„å»ºæ—¥æœŸ: ${{ env.BUILD_DATE }}"
        echo "æ¶æ„: x86_64 WOW64"
        echo "ç¯å¢ƒ: Termux"
        echo "åº”ç”¨ä¿®å¤:"
        echo "âœ“ Wine ${{ env.WINE_VERSION }} mfplat ä¿®å¤"
        echo "âœ“ è¿”å›å€¼ä¿®å¤"
        echo "âœ“ Esync ä¿®å¤"
        echo "âœ“ Termux è·¯å¾„ä¿®å¤"